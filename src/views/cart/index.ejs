<%- include('../partials/head') %>
<%- include('../partials/header') %>

<style type="text/tailwindcss">
  body { font-family: 'Inter', sans-serif; }
  h1, h2, h3, .font-display { font-family: 'Outfit', sans-serif; }
  .product-card {
    @apply bg-white dark:bg-surface-dark rounded-2xl overflow-hidden border border-slate-100 dark:border-slate-800 transition-all duration-300 flex flex-col;
  }
  .summary-card {
    @apply bg-slate-50 dark:bg-slate-900/50 rounded-3xl p-8 border border-slate-100 dark:border-slate-800;
  }
</style>

<main class="flex-1 container mx-auto px-4 lg:px-8 py-10">
  <% const formatMoney = (cents) => new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Math.round((Number(cents) || 0)) / 100); %>
  <% const itemsCount = typeof cartItemCount !== 'undefined' ? cartItemCount : (items || []).reduce((sum, it) => sum + (it.quantity || 0), 0); %>
  <% const vatCents = Math.max(0, Math.round((Number(totalCents) || 0) - (Number(totalCents) || 0) / 1.2)); %>

  <% if (!dbConnected) { %>
    <div class="mb-8 rounded-2xl border border-amber-200 bg-amber-50 p-5 text-amber-900">
      <div class="font-bold">Mode démo activé</div>
      <div class="mt-1 text-sm">Le site fonctionne sans base de données, avec des produits d'exemple.</div>
    </div>
  <% } %>

  <% if (errorMessage) { %>
    <div class="mb-8 rounded-2xl border border-red-200 bg-red-50 p-5 text-red-900">
      <div class="font-bold">Erreur</div>
      <div class="mt-1 text-sm"><%= errorMessage %></div>
    </div>
  <% } %>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
    <div class="lg:col-span-8">
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-display font-bold">Votre Panier <span class="text-slate-400 font-normal text-xl ml-2">(<%= itemsCount %> article<%= itemsCount > 1 ? 's' : '' %>)</span></h1>
        <form action="/panier/vider" method="POST">
          <button class="text-slate-500 hover:text-primary text-sm flex items-center gap-1 transition-colors" <%= items && items.length ? '' : 'disabled' %> type="submit">
            <span class="material-symbols-outlined text-lg">delete_sweep</span>
            Vider le panier
          </button>
        </form>
      </div>

      <% if (!items || items.length === 0) { %>
        <div class="bg-white dark:bg-surface-dark rounded-3xl p-8 border border-slate-100 dark:border-slate-800 shadow-sm">
          <h3 class="font-display font-bold text-xl">Votre panier est vide</h3>
          <p class="mt-2 text-slate-600 dark:text-slate-400 text-sm">Ajoutez un produit depuis le catalogue.</p>
          <div class="mt-6">
            <a class="inline-flex items-center justify-center rounded-2xl bg-primary hover:bg-red-700 text-white py-4 px-6 font-bold text-sm shadow-xl shadow-red-500/20 transition-all" href="/produits">
              Continuer mes achats
              <span class="material-symbols-outlined ml-2">arrow_forward</span>
            </a>
          </div>
        </div>
      <% } else { %>
        <div class="space-y-6">
          <% items.forEach((it) => { %>
            <div class="bg-white dark:bg-surface-dark rounded-3xl p-6 border border-slate-100 dark:border-slate-800 shadow-sm flex flex-col sm:flex-row gap-6 items-start sm:items-center">
              <div class="w-full sm:w-40 aspect-square rounded-2xl overflow-hidden bg-slate-100 flex-shrink-0">
                <% if (it.product && it.product.imageUrl) { %>
                  <img alt="<%= it.product.name %>" class="w-full h-full object-cover" src="<%= it.product.imageUrl %>" />
                <% } else { %>
                  <div class="w-full h-full flex items-center justify-center">
                    <span class="material-symbols-outlined text-5xl text-slate-400">inventory_2</span>
                  </div>
                <% } %>
              </div>

              <div class="flex-grow w-full">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <h3 class="font-bold text-lg text-slate-900 dark:text-white leading-tight mb-1"><%= it.product ? it.product.name : '' %></h3>
                    <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 text-[10px] font-bold uppercase tracking-wide">
                      <span class="material-symbols-outlined text-sm">check_circle</span>
                      Compatible avec votre véhicule
                    </div>
                  </div>
                </div>

                <% if (it.product && it.product.sku) { %>
                  <p class="text-sm text-slate-500 mb-4">Réf: <%= it.product.sku %></p>
                <% } else { %>
                  <p class="text-sm text-slate-500 mb-4">&nbsp;</p>
                <% } %>

                <div class="flex flex-wrap items-center justify-between gap-4 mt-auto">
                  <form action="/panier/modifier/<%= it.product && it.product._id ? it.product._id : '' %>" class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-xl p-1 border border-slate-200/50 dark:border-slate-700/50" data-qty-form method="POST">
                    <input name="returnTo" type="hidden" value="/panier" />
                    <input name="qty" type="hidden" value="<%= it.quantity %>" />

                    <button class="w-8 h-8 flex items-center justify-center hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-all text-slate-500 hover:text-primary" data-qty-delta="-1" type="button">
                      <span class="material-symbols-outlined text-lg">remove</span>
                    </button>
                    <span class="w-10 text-center font-bold text-sm" data-qty-value><%= it.quantity %></span>
                    <button class="w-8 h-8 flex items-center justify-center hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-all text-slate-500 hover:text-primary" data-qty-delta="1" type="button">
                      <span class="material-symbols-outlined text-lg">add</span>
                    </button>
                  </form>

                  <div class="text-right">
                    <p class="text-xl font-display font-bold text-slate-900 dark:text-white"><%= formatMoney(it.lineTotalCents) %> €</p>
                    <form action="/panier/supprimer/<%= it.product && it.product._id ? it.product._id : '' %>" method="POST">
                      <input name="returnTo" type="hidden" value="/panier" />
                      <button class="text-slate-400 hover:text-primary text-xs font-semibold underline underline-offset-4 mt-1 transition-colors" type="submit">Supprimer</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <div class="mt-16">
          <h2 class="text-xl font-display font-bold mb-6">Complétez votre commande</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
            <% (suggestedProducts || []).forEach((p) => { %>
              <div class="product-card group p-3">
                <div class="aspect-square rounded-xl overflow-hidden mb-3 bg-slate-100">
                  <% if (p && p.imageUrl) { %>
                    <img alt="<%= p.name %>" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" src="<%= p.imageUrl %>" />
                  <% } else { %>
                    <div class="w-full h-full flex items-center justify-center">
                      <span class="material-symbols-outlined text-5xl text-slate-400">inventory_2</span>
                    </div>
                  <% } %>
                </div>
                <h4 class="text-xs font-bold line-clamp-2 h-8 mb-2"><%= p && p.name ? p.name : '' %></h4>
                <div class="flex items-center justify-between mt-auto">
                  <span class="font-bold text-sm"><%= formatMoney(p && p.priceCents ? p.priceCents : 0) %> €</span>
                  <form action="/panier/ajouter/<%= p && p._id ? p._id : '' %>" method="POST">
                    <input name="returnTo" type="hidden" value="/panier" />
                    <button class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-primary hover:text-white flex items-center justify-center transition-colors" type="submit">
                      <span class="material-symbols-outlined text-sm">add_shopping_cart</span>
                    </button>
                  </form>
                </div>
              </div>
            <% }) %>
          </div>
        </div>
      <% } %>
    </div>

    <div class="lg:col-span-4">
      <div class="summary-card lg:sticky lg:top-28">
        <h2 class="text-xl font-bold mb-6">Récapitulatif</h2>

        <div class="space-y-4 mb-8">
          <div class="flex justify-between text-slate-600 dark:text-slate-400">
            <span>Sous-total</span>
            <span class="font-semibold text-slate-900 dark:text-white"><%= formatMoney(typeof itemsSubtotalCents !== 'undefined' ? itemsSubtotalCents : totalCents) %> €</span>
          </div>
        </div>

        <div class="mb-8">
          <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Code Promo</label>
          <form action="/panier/code-promo" class="flex gap-2" method="POST">
            <input class="flex-grow bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 rounded-xl py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" name="code" placeholder="Entrez votre code" type="text" value="<%= typeof promoCode !== 'undefined' ? promoCode : '' %>" />
            <button class="bg-slate-900 dark:bg-slate-700 text-white px-6 py-2.5 rounded-xl font-bold text-sm hover:bg-slate-800 transition-colors" type="submit">Appliquer</button>
          </form>
          <% if (typeof promoCode !== 'undefined' && promoCode) { %>
            <form action="/panier/code-promo" class="mt-2" method="POST" onsubmit="return confirm('Supprimer le code promo ?');">
              <input name="code" type="hidden" value="" />
              <button class="text-xs font-bold text-slate-500 hover:text-primary underline underline-offset-4" type="submit">Supprimer le code</button>
            </form>
          <% } %>
        </div>

        <div class="space-y-4 mb-8">
          <% if (typeof clientDiscountCents !== 'undefined' && clientDiscountCents > 0) { %>
            <div class="flex justify-between text-slate-600 dark:text-slate-400">
              <span>Remise compte (<%= typeof clientDiscountPercent !== 'undefined' ? String(clientDiscountPercent).replace('.', ',') : '' %>%)</span>
              <span class="font-semibold text-slate-900 dark:text-white">- <%= formatMoney(clientDiscountCents) %> €</span>
            </div>
          <% } %>

          <% if (typeof promoDiscountCents !== 'undefined' && promoDiscountCents > 0) { %>
            <div class="flex justify-between text-slate-600 dark:text-slate-400">
              <span>Code promo <%= promoCode ? '(' + promoCode + ')' : '' %></span>
              <span class="font-semibold text-slate-900 dark:text-white">- <%= formatMoney(promoDiscountCents) %> €</span>
            </div>
          <% } %>

          <% if ((typeof clientDiscountCents !== 'undefined' && clientDiscountCents > 0) || (typeof promoDiscountCents !== 'undefined' && promoDiscountCents > 0)) { %>
            <div class="flex justify-between text-slate-600 dark:text-slate-400">
              <span>Sous-total après remise</span>
              <span class="font-semibold text-slate-900 dark:text-white"><%= formatMoney(typeof itemsTotalAfterDiscountCents !== 'undefined' ? itemsTotalAfterDiscountCents : totalCents) %> €</span>
            </div>
          <% } %>
        </div>

        <div class="pt-6 border-t border-slate-200 dark:border-slate-800 mb-8">
          <div class="flex justify-between items-end">
            <span class="text-lg font-bold">Total TTC</span>
            <div class="text-right">
              <p class="text-3xl font-display font-bold text-primary"><%= formatMoney(totalCents) %> €</p>
              <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mt-1">TVA incluse (<%= formatMoney(vatCents) %> €)</p>
            </div>
          </div>
        </div>

        <% if (!currentUser) { %>
          <a class="w-full bg-primary hover:bg-red-700 text-white py-5 rounded-2xl font-bold text-lg shadow-xl shadow-red-500/20 transition-all flex items-center justify-center gap-3" href="/compte/connexion?returnTo=%2Fpanier">
            Valider ma commande
            <span class="material-symbols-outlined">arrow_forward</span>
          </a>
        <% } else { %>
          <a class="w-full bg-primary hover:bg-red-700 text-white py-5 rounded-2xl font-bold text-lg shadow-xl shadow-red-500/20 transition-all flex items-center justify-center gap-3" href="/commande/livraison">
            Valider ma commande
            <span class="material-symbols-outlined">arrow_forward</span>
          </a>
        <% } %>

        <div class="mt-8 space-y-4">
          <div class="flex items-center gap-3 text-sm text-slate-600 dark:text-slate-400">
            <span class="material-symbols-outlined text-primary">verified_user</span>
            <span>Paiement 100% sécurisé</span>
          </div>
          <div class="flex items-center gap-3 text-sm text-slate-600 dark:text-slate-400">
            <span class="material-symbols-outlined text-primary">local_shipping</span>
            <span>Expédition sous 24h</span>
          </div>
          <div class="flex items-center gap-3 text-sm text-slate-600 dark:text-slate-400">
            <span class="material-symbols-outlined text-primary">replay</span>
            <span>Retours gratuits sous 30 jours</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  (function () {
    const clamp = (n) => {
      if (!Number.isFinite(n)) return 1;
      if (n < 0) return 0;
      if (n > 99) return 99;
      return n;
    };

    const forms = Array.from(document.querySelectorAll('[data-qty-form]'));
    forms.forEach((form) => {
      const qtyInput = form.querySelector('input[name="qty"]');
      const qtyValue = form.querySelector('[data-qty-value]');
      const buttons = Array.from(form.querySelectorAll('[data-qty-delta]'));

      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const delta = Number(btn.getAttribute('data-qty-delta') || '0');
          const current = qtyInput ? Number(qtyInput.value) : 1;
          const next = clamp(current + delta);
          if (qtyInput) qtyInput.value = String(next);
          if (qtyValue) qtyValue.textContent = String(next);
          form.submit();
        });
      });
    });
  })();
</script>

<%- include('../partials/footer') %>
