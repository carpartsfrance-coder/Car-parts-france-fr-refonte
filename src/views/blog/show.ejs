<%- include('../partials/head') %>
<div class="bg-primary text-white text-center py-2 text-sm font-medium">
  Offre Spéciale : -5% sur toute commande cette semaine avec le code : <span class="font-bold underline">PROMO5</span>
</div>

<%- include('../partials/header') %>

<style type="text/tailwindcss">
  .font-display { font-family: 'Outfit', sans-serif; }
  .article-content { max-width: 72ch; margin-left: auto; margin-right: auto; }
  .prose h2 { font-family: 'Outfit', sans-serif; font-weight: 700; color: #111827; margin-top: 1.5rem; margin-bottom: 0.75rem; font-size: 1.5rem; }
  .prose h3 { font-family: 'Outfit', sans-serif; font-weight: 600; color: #111827; margin-top: 1.25rem; margin-bottom: 0.5rem; font-size: 1.25rem; }
  .prose h4 { font-family: 'Outfit', sans-serif; font-weight: 700; color: #111827; margin-top: 1.1rem; margin-bottom: 0.4rem; font-size: 1.1rem; }
  .prose h2, .prose h3, .prose h4 { scroll-margin-top: 7rem; }
  .prose p { margin-bottom: 1rem; line-height: 1.6; color: #374151; font-size: 0.9375rem; }
  .prose ul { margin-bottom: 1rem; list-style-type: disc; padding-left: 1.25rem; }
  .prose ol { margin-bottom: 1rem; list-style-type: decimal; padding-left: 1.25rem; }
  .prose li { margin-bottom: 0.25rem; color: #374151; font-size: 0.9375rem; }
  .prose a { color: #ef4444; text-decoration: underline; text-underline-offset: 2px; }
  .prose strong { color: inherit; font-weight: 800; }
  .prose blockquote { margin: 1rem 0; padding: 0.75rem 1rem; border-left: 4px solid #ef4444; background: #f8fafc; color: #111827; border-radius: 0.75rem; }
  .prose hr { margin: 1.5rem 0; border: 0; border-top: 1px solid #e5e7eb; }
  .prose pre { margin: 1rem 0; padding: 1rem; background: #0b1220; color: #e5e7eb; border-radius: 0.75rem; overflow: auto; font-size: 0.875rem; }
  .prose code { background: #f1f5f9; padding: 0.1rem 0.35rem; border-radius: 0.4rem; font-size: 0.875em; }
  .prose pre code { background: transparent; padding: 0; }

  .dark .prose h2,
  .dark .prose h3,
  .dark .prose h4 { color: #f8fafc; }
  .dark .prose p,
  .dark .prose li { color: #e2e8f0; }
  .dark .prose blockquote { background: rgba(15, 23, 42, 0.6); color: #f8fafc; }
  .dark .prose hr { border-top-color: rgba(148, 163, 184, 0.35); }
  .dark .prose code { background: rgba(148, 163, 184, 0.18); }
</style>

<main class="flex-1 bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 transition-colors duration-300">
  <div class="container mx-auto px-4 lg:px-8 py-4">

    <nav class="flex items-center gap-2 text-[10px] font-semibold text-slate-400 uppercase tracking-wider mb-4">
      <a class="hover:text-primary transition-colors" href="/">Accueil</a>
      <span class="material-symbols-outlined text-[12px]">chevron_right</span>
      <a class="hover:text-primary transition-colors" href="/blog">Blog</a>
      <% if (post && post.category && post.category.label) { %>
        <span class="material-symbols-outlined text-[12px]">chevron_right</span>
        <span class="text-slate-600 dark:text-slate-200"><%= post.category.label %></span>
      <% } %>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <div class="lg:col-span-8">
        <article class="bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden">
          <% if (post && post.coverImageUrl) { %>
            <img alt="<%= post.title %>" class="w-full h-72 object-cover" src="<%= post.coverImageUrl %>"/>
          <% } %>

          <div class="p-6 lg:p-8">
            <div class="flex items-center flex-wrap gap-4 text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-3">
              <span class="flex items-center gap-1">
                <span class="material-symbols-outlined text-sm text-primary">person</span>
                Par <%= post && post.authorName ? post.authorName : 'CarParts' %>
              </span>
              <span class="flex items-center gap-1">
                <span class="material-symbols-outlined text-sm text-primary">calendar_today</span>
                <%= post && post.dateLabel ? post.dateLabel : '' %>
              </span>
              <span class="flex items-center gap-1">
                <span class="material-symbols-outlined text-sm text-primary">schedule</span>
                <%= post && post.readingTimeLabel ? post.readingTimeLabel : '' %>
              </span>
            </div>

            <h1 class="text-3xl lg:text-4xl font-display font-bold text-slate-900 dark:text-white mb-6 leading-tight"><%= post && post.title ? post.title : '' %></h1>

            <% if (post && post.excerpt) { %>
              <div class="bg-slate-50 dark:bg-slate-800/40 border border-slate-200 dark:border-slate-700 rounded-xl p-4 mb-6">
                <p class="text-sm text-slate-700 dark:text-slate-200 leading-relaxed font-medium"><%= post.excerpt %></p>
              </div>
            <% } %>

            <div class="prose dark:prose-invert max-w-none article-content">
              <%- post && post.contentHtml ? post.contentHtml : '' %>
            </div>
          </div>
        </article>
      </div>

      <aside class="lg:col-span-4 space-y-6 lg:sticky lg:top-24 lg:max-h-[calc(100vh-6rem)] lg:overflow-auto lg:pr-1">
        <div id="tocCard" class="hidden bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
          <h3 class="font-display font-bold text-sm uppercase tracking-widest text-slate-900 dark:text-white mb-4 flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-primary rounded-full"></span> Sommaire
          </h3>
          <div id="tocList" class="space-y-0.5 text-[11px]"></div>
        </div>

        <% if (relatedProducts && relatedProducts.length) { %>
          <div class="bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
            <h3 class="font-display font-bold text-sm uppercase tracking-widest text-slate-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="w-1.5 h-1.5 bg-primary rounded-full"></span> Produits Liés
            </h3>

            <div class="space-y-4">
              <% relatedProducts.forEach((p) => { %>
                <div class="flex gap-3 group">
                  <a class="w-20 h-20 rounded-lg overflow-hidden flex-shrink-0 border border-slate-100 dark:border-slate-800" href="<%= p.url %>">
                    <% if (p.imageUrl) { %>
                      <img alt="<%= p.name %>" class="w-full h-full object-cover" src="<%= p.imageUrl %>"/>
                    <% } else { %>
                      <div class="w-full h-full bg-slate-100 dark:bg-slate-800"></div>
                    <% } %>
                  </a>

                  <div class="flex flex-col justify-between py-0.5">
                    <div>
                      <a class="text-[11px] font-bold line-clamp-2 leading-tight group-hover:text-primary transition-colors" href="<%= p.url %>"><%= p.name %></a>
                      <% if (p.priceLabel) { %>
                        <p class="text-[13px] font-display font-bold text-slate-900 dark:text-white mt-1"><%= p.priceLabel %></p>
                      <% } %>
                    </div>

                    <form action="/panier/ajouter/<%= p.id %>" method="POST">
                      <button class="bg-slate-900 text-white text-[9px] font-bold px-3 py-1 rounded hover:bg-primary transition-colors uppercase w-fit" type="submit">Ajouter</button>
                    </form>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        <% } %>

        <% if (similarPosts && similarPosts.length) { %>
          <div class="bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
            <h3 class="font-display font-bold text-sm uppercase tracking-widest text-slate-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="w-1.5 h-1.5 bg-primary rounded-full"></span> Articles Similaires
            </h3>

            <div class="space-y-4">
              <% similarPosts.slice(0, 4).forEach((s) => { %>
                <a class="flex gap-3 group" href="<%= s.url %>">
                  <div class="w-16 h-12 rounded overflow-hidden flex-shrink-0">
                    <% if (s.imageUrl) { %>
                      <img alt="<%= s.title %>" class="w-full h-full object-cover" src="<%= s.imageUrl %>"/>
                    <% } else { %>
                      <div class="w-full h-full bg-slate-100 dark:bg-slate-800"></div>
                    <% } %>
                  </div>
                  <p class="text-[11px] font-semibold leading-snug group-hover:text-primary transition-colors"><%= s.title %></p>
                </a>
              <% }) %>
            </div>
          </div>
        <% } %>

        <div class="bg-accent-dark text-white p-5 rounded-xl relative overflow-hidden">
          <div class="relative z-10">
            <h3 class="text-lg font-display font-bold mb-2">Restez informé</h3>
            <p class="text-[11px] text-slate-400 mb-4">Recevez nos guides techniques et offres exclusives chaque mois.</p>
            <form class="space-y-2" onsubmit="return false;">
              <input class="w-full bg-white/10 border-white/20 rounded-lg py-1.5 px-3 text-xs focus:ring-primary focus:border-primary" placeholder="Votre email" type="email"/>
              <button class="w-full bg-primary hover:bg-red-700 text-white font-bold py-2 rounded-lg text-xs transition-all uppercase" type="submit">S'abonner</button>
            </form>
          </div>
        </div>
      </aside>
    </div>
  </div>
</main>

<script>
  (function () {
    function slugify(value) {
      var input = String(value || '').trim().toLowerCase();
      if (!input) return '';
      try {
        input = input.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      } catch (e) {
      }
      input = input.replace(/[^a-z0-9\s-]/g, ' ');
      input = input.replace(/\s+/g, '-');
      input = input.replace(/-+/g, '-');
      input = input.replace(/^-|-$/g, '');
      return input;
    }

    if (!window.matchMedia || !window.matchMedia('(min-width: 1024px)').matches) return;

    var content = document.querySelector('.prose');
    var card = document.getElementById('tocCard');
    var list = document.getElementById('tocList');
    if (!content || !card || !list) return;

    var headings = Array.prototype.slice.call(content.querySelectorAll('h2, h3'));
    if (!headings.length) return;

    var items = [];
    for (var i = 0; i < headings.length; i += 1) {
      var h = headings[i];
      var text = String(h.textContent || '').trim();
      if (!text) continue;

      if (text.toLowerCase() === 'sommaire') continue;

      if (!h.id) {
        var base = slugify(text) || ('section-' + (i + 1));
        var id = base;
        var n = 2;
        while (document.getElementById(id)) {
          id = base + '-' + n;
          n += 1;
        }
        h.id = id;
      }

      var level = h.tagName === 'H2' ? 0 : 1;
      items.push({ id: h.id, text: text, level: level });
    }

    if (items.length < 2) return;

    if (items.length > 10) {
      items = items.slice(0, 8).concat(items.slice(-2));
    }

    list.innerHTML = items.map(function (it) {
      var pad = it.level === 0 ? '' : it.level === 1 ? 'padding-left:12px;' : 'padding-left:22px;';
      return '<a href="#' + it.id + '" style="' + pad + '" class="block py-1 leading-snug break-words text-slate-600 dark:text-slate-200 hover:text-primary transition-colors">' + it.text + '</a>';
    }).join('');

    card.classList.remove('hidden');
  })();
</script>

<%- include('../partials/footer') %>
