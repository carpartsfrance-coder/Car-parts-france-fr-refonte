<%- include('./partials/head') %>

<%- include('./partials/sidebar', { active: 'clients' }) %>

<main class="flex-1">
  <div class="px-6 lg:px-10 py-8">
    <div class="flex flex-col gap-4">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <a class="w-10 h-10 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-center bg-white" href="/admin/clients">
            <span class="material-symbols-outlined text-slate-500">arrow_back</span>
          </a>
          <div class="text-xs font-black uppercase tracking-widest text-slate-400">
            Clients
            <span class="mx-2 text-slate-300">/</span>
            <span class="text-slate-500"><%= customer ? customer.name : 'Client' %></span>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <% if (customer) { %>
            <a class="hidden sm:inline-flex items-center justify-center rounded-xl bg-white px-4 py-2 text-xs font-black uppercase tracking-wider text-slate-700 border border-slate-200 hover:bg-slate-50 transition" href="#remise">
              <span class="material-symbols-outlined mr-2 text-base">edit</span>
              Modifier le profil
            </a>
            <a class="inline-flex items-center justify-center rounded-xl bg-primary px-4 py-2 text-xs font-black uppercase tracking-wider text-white hover:bg-red-700 transition" href="mailto:<%= customer.email %>">
              <span class="material-symbols-outlined mr-2 text-base">mail</span>
              Contacter
            </a>
          <% } %>
        </div>
      </div>

      <% if (customer) { %>
        <div>
          <div class="flex items-center gap-3">
            <div class="text-2xl md:text-3xl font-black text-slate-900"><%= customer.name %></div>
            <span class="inline-flex items-center rounded-full px-3 py-1 text-[10px] font-black uppercase tracking-widest <%= customer.accountType === 'pro' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700' %>">
              <%= customer.accountType === 'pro' ? 'PRO' : 'PARTICULIER' %>
            </span>
          </div>
          <div class="mt-1 text-sm text-slate-500">
            ID Client: <span class="font-semibold text-slate-700"><%= customer.id %></span>
            <span class="mx-2 text-slate-300">•</span>
            Inscrit depuis <span class="font-semibold text-slate-700"><%= String(customer.createdAt || '').split(' • ')[0] %></span>
          </div>
        </div>
      <% } %>
    </div>

    <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
      <div class="mt-6 rounded-xl border border-red-200 bg-red-50 p-4 text-red-900">
        <div class="font-bold">Erreur</div>
        <div class="mt-1 text-sm"><%= errorMessage %></div>
      </div>
    <% } %>

    <% if (!customer) { %>
      <div class="mt-8 bg-white rounded-2xl border border-slate-200 p-6">
        <div class="text-slate-600">Aucune donnée client.</div>
      </div>
    <% } else { %>
      <div class="mt-8 grid grid-cols-1 xl:grid-cols-12 gap-6">
        <section class="xl:col-span-5 space-y-6">
          <div class="bg-white rounded-2xl border border-slate-200 p-6">
            <div class="flex flex-col items-center text-center">
              <div class="w-20 h-20 rounded-full bg-slate-100 flex items-center justify-center">
                <span class="material-symbols-outlined text-slate-400 text-4xl">person</span>
              </div>
              <div class="mt-4 text-lg font-black text-slate-900"><%= customer.name %></div>
              <div class="mt-1 text-sm text-slate-500"><%= customer.email %></div>
            </div>

            <div class="mt-6 divide-y divide-slate-100 text-sm">
              <div class="flex items-center justify-between py-3">
                <div class="text-slate-500">Téléphone</div>
                <div class="font-black text-slate-900"><%= customer.phone ? customer.phone : '—' %></div>
              </div>
              <div class="flex items-center justify-between py-3">
                <div class="text-slate-500">Pays / Ville</div>
                <div class="font-black text-slate-900"><%= customer.location ? customer.location : '—' %></div>
              </div>
              <div class="flex items-center justify-between py-3">
                <div class="text-slate-500">Total Commandes</div>
                <div class="font-black text-slate-900"><%= Number.isFinite(customer.ordersCount) ? customer.ordersCount : 0 %> commandes</div>
              </div>
              <div class="flex items-center justify-between py-3">
                <div class="text-slate-500">Dernière commande</div>
                <div class="font-black text-slate-900"><%= customer.lastOrderRelative ? customer.lastOrderRelative : '—' %></div>
              </div>

              <% if (customer.accountType === 'pro') { %>
                <div class="flex items-center justify-between py-3">
                  <div class="text-slate-500">Société</div>
                  <div class="font-black text-slate-900"><%= customer.companyName || '—' %></div>
                </div>
                <div class="flex items-center justify-between py-3">
                  <div class="text-slate-500">SIRET</div>
                  <div class="font-black text-slate-900"><%= customer.siret || '—' %></div>
                </div>
              <% } %>
            </div>
          </div>

          <div class="bg-white rounded-2xl border border-slate-200 p-6" id="remise">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-primary">percent</span>
              <div class="text-sm font-black text-slate-900">Remise Client</div>
            </div>

            <form action="/admin/clients/<%= customer.id %>/remise" class="mt-5" method="POST">
              <div class="flex items-center justify-between">
                <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">Taux de remise (%)</div>
                <div class="text-sm font-black text-primary" id="discountValue"><%= typeof customer.discountPercent !== 'undefined' ? customer.discountPercent : 0 %>%</div>
              </div>

              <div class="mt-4 flex items-center gap-4">
                <input class="flex-1" id="discountRange" max="90" min="0" step="0.01" type="range" value="<%= typeof customer.discountPercent !== 'undefined' ? customer.discountPercent : 0 %>" />
                <div class="w-24">
                  <input class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-black text-slate-900" id="discountNumber" max="90" min="0" name="discountPercent" step="0.01" type="number" value="<%= typeof customer.discountPercent !== 'undefined' ? customer.discountPercent : 0 %>" />
                </div>
              </div>

              <button class="mt-5 w-full inline-flex items-center justify-center rounded-xl bg-slate-900 px-5 py-3 text-xs font-black uppercase tracking-wider text-white hover:bg-slate-800 transition" type="submit">
                Enregistrer
              </button>
            </form>
          </div>
        </section>

        <section class="xl:col-span-7">
          <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 bg-slate-50 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div class="font-black text-slate-900">Historique des commandes</div>
              <form class="flex flex-col sm:flex-row sm:items-center gap-3" method="GET">
                <div class="relative">
                  <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]">search</span>
                  <input class="w-64 max-w-full rounded-xl border border-slate-200 bg-white pl-10 pr-4 py-2 text-sm font-semibold text-slate-900 placeholder:text-slate-400" name="q" placeholder="Commande, pièce, SKU..." type="text" value="<%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.q ? orderFilters.q : '' %>" />
                </div>

                <select class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-bold text-slate-900" name="status">
                  <option value="">Tous statuts</option>
                  <option value="en_attente" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.status === 'en_attente' ? 'selected' : '' %>>En attente</option>
                  <option value="validee" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.status === 'validee' ? 'selected' : '' %>>En préparation</option>
                  <option value="expediee" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.status === 'expediee' ? 'selected' : '' %>>Expédiée</option>
                  <option value="livree" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.status === 'livree' ? 'selected' : '' %>>Livrée</option>
                  <option value="annulee" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.status === 'annulee' ? 'selected' : '' %>>Annulée</option>
                </select>

                <select class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-bold text-slate-900" name="period">
                  <option value="">Toutes périodes</option>
                  <option value="7d" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.period === '7d' ? 'selected' : '' %>>7 jours</option>
                  <option value="30d" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.period === '30d' ? 'selected' : '' %>>30 jours</option>
                  <option value="90d" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.period === '90d' ? 'selected' : '' %>>90 jours</option>
                  <option value="365d" <%= typeof orderFilters !== 'undefined' && orderFilters && orderFilters.period === '365d' ? 'selected' : '' %>>12 mois</option>
                </select>

                <button class="w-10 h-10 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition flex items-center justify-center" type="submit" title="Filtrer">
                  <span class="material-symbols-outlined text-slate-500">tune</span>
                </button>
              </form>
            </div>

            <% if (orders && orders.length) { %>
              <div class="overflow-x-auto">
                <table class="w-full text-left">
                  <thead>
                    <tr class="text-xs font-black text-slate-400 uppercase tracking-widest bg-white">
                      <th class="px-6 py-4">ID commande</th>
                      <th class="px-6 py-4">Date</th>
                      <th class="px-6 py-4">Articles</th>
                      <th class="px-6 py-4">Total</th>
                      <th class="px-6 py-4">Statut</th>
                      <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100">
                    <% orders.forEach((o) => { %>
                      <tr data-order-row data-order-number="<%= String(o.number || '').toLowerCase() %>">
                        <td class="px-6 py-4 font-black text-primary"><%= o.numberDisplay %></td>
                        <td class="px-6 py-4">
                          <div class="text-sm font-black text-slate-900"><%= o.date %></div>
                          <div class="text-xs text-slate-400"><%= o.time %></div>
                        </td>
                        <td class="px-6 py-4">
                          <div class="text-sm font-black text-slate-900"><%= o.itemCount %></div>
                          <div class="text-xs text-slate-400"><%= o.itemCount > 1 ? 'articles' : 'article' %></div>
                        </td>
                        <td class="px-6 py-4 font-black text-slate-900"><%= o.total %></td>
                        <td class="px-6 py-4">
                          <span class="inline-flex items-center rounded-full px-3 py-1 text-[10px] font-black uppercase tracking-widest <%= o.statusBadge.className %>">
                            <%= o.statusBadge.label %>
                          </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                          <a class="w-10 h-10 inline-flex items-center justify-center rounded-full border border-slate-200 bg-white hover:bg-slate-50 transition" href="/admin/commandes/<%= o.id %>" title="Voir la commande">
                            <span class="material-symbols-outlined text-slate-500">visibility</span>
                          </a>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>

              <div class="px-6 py-4 border-t border-slate-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="text-xs font-black uppercase tracking-widest text-slate-400">
                  <% if (typeof pagination !== 'undefined' && pagination) { %>
                    Affichage <%= pagination.from %>-<%= pagination.to %> sur <%= pagination.totalItems %>
                  <% } else { %>
                    Affichage 1-<%= orders.length %> sur <%= Number.isFinite(customer.ordersCount) ? customer.ordersCount : orders.length %>
                  <% } %>
                </div>

                <% 
                  const qVal = typeof orderFilters !== 'undefined' && orderFilters && orderFilters.q ? String(orderFilters.q) : '';
                  const statusVal = typeof orderFilters !== 'undefined' && orderFilters && orderFilters.status ? String(orderFilters.status) : '';
                  const periodVal = typeof orderFilters !== 'undefined' && orderFilters && orderFilters.period ? String(orderFilters.period) : '';
                  const extraQuery = [
                    qVal ? `q=${encodeURIComponent(qVal)}` : '',
                    statusVal ? `status=${encodeURIComponent(statusVal)}` : '',
                    periodVal ? `period=${encodeURIComponent(periodVal)}` : '',
                  ].filter(Boolean).join('&');
                  const withExtra = extraQuery ? `&${extraQuery}` : '';
                %>

                <% if (typeof pagination !== 'undefined' && pagination && pagination.totalPages > 1) { %>
                  <div class="flex items-center justify-end gap-2">
                    <a class="w-9 h-9 inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition <%= pagination.hasPrev ? '' : 'opacity-40 pointer-events-none' %>" href="?page=<%= pagination.prevPage %><%= withExtra %>" aria-label="Page précédente">
                      <span class="material-symbols-outlined text-slate-500">chevron_left</span>
                    </a>

                    <% const startPage = Math.max(1, pagination.page - 2); %>
                    <% const endPage = Math.min(pagination.totalPages, pagination.page + 2); %>
                    <% for (let p = startPage; p <= endPage; p += 1) { %>
                      <a class="w-9 h-9 inline-flex items-center justify-center rounded-xl border text-xs font-black <%= p === pagination.page ? 'bg-primary text-white border-primary' : 'bg-white text-slate-700 border-slate-200 hover:bg-slate-50' %>" href="?page=<%= p %><%= withExtra %>"><%= p %></a>
                    <% } %>

                    <a class="w-9 h-9 inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition <%= pagination.hasNext ? '' : 'opacity-40 pointer-events-none' %>" href="?page=<%= pagination.nextPage %><%= withExtra %>" aria-label="Page suivante">
                      <span class="material-symbols-outlined text-slate-500">chevron_right</span>
                    </a>
                  </div>
                <% } %>
              </div>
            <% } else { %>
              <div class="p-6 text-slate-600">Aucune commande.</div>
            <% } %>
          </div>
        </section>
      </div>

      <% if (!dbConnected) { %>
        <div class="mt-8 rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
          <div class="font-bold">Mode démo</div>
          <div class="mt-1 text-sm">La base de données est indisponible : la fiche client n’est pas disponible.</div>
        </div>
      <% } %>
    <% } %>

    <script>
      (function () {
        const range = document.getElementById('discountRange');
        const number = document.getElementById('discountNumber');
        const label = document.getElementById('discountValue');

        function clamp(v) {
          const n = Number(v);
          if (!Number.isFinite(n)) return 0;
          if (n < 0) return 0;
          if (n > 90) return 90;
          return n;
        }

        function syncFromRange() {
          const v = clamp(range.value);
          number.value = String(v);
          if (label) label.textContent = v + '%';
        }

        function syncFromNumber() {
          const v = clamp(number.value);
          range.value = String(v);
          if (label) label.textContent = v + '%';
        }

        if (range && number) {
          range.addEventListener('input', syncFromRange);
          number.addEventListener('input', syncFromNumber);
          syncFromNumber();
        }

      })();
    </script>
  </div>
</main>

<%- include('./partials/footer') %>
