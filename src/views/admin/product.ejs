<%- include('./partials/head') %>

<%- include('./partials/sidebar', { active: 'catalog' }) %>

<main class="flex-1">
  <% const pageTitle = mode === 'new' ? 'New Product' : 'Edit Product'; %>
  <% const productName = form && form.name ? form.name : (mode === 'new' ? 'New product' : 'Product'); %>
  <% const liveUrl = mode === 'edit' && productId ? ('/produits/' + productId) : null; %>
  <% const galleryPreview = (form && form.galleryUrls ? String(form.galleryUrls).split(/\r?\n/).map((s) => s.trim()).filter(Boolean) : []).slice(0, 5); %>
  <% const specsText = form && typeof form.specs !== 'undefined' ? String(form.specs || '') : ''; %>
  <% const findSpecValue = (label) => {
    const target = String(label || '').trim().toLowerCase();
    if (!target) return '';
    const lines = String(specsText || '').split(/\r?\n/).map((s) => s.trim()).filter(Boolean);
    for (const line of lines) {
      const sepIndex = line.indexOf(':') >= 0 ? line.indexOf(':') : (line.indexOf('=') >= 0 ? line.indexOf('=') : line.indexOf('|'));
      if (sepIndex <= 0) continue;
      const rawLabel = line.slice(0, sepIndex).trim().toLowerCase();
      if (rawLabel !== target) continue;
      return line.slice(sepIndex + 1).trim();
    }
    return '';
  }; %>
  <% const specTypeValue = findSpecValue('type'); %>
  <% const specProgrammationValue = findSpecValue('programmation'); %>

  <header class="bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-border-dark sticky top-0 z-50">
    <div class="px-8 py-4 flex items-center justify-between">
      <div>
        <div class="flex items-center gap-2 text-xs text-gray-400 uppercase tracking-widest mb-1">
          <a class="hover:text-primary" href="/admin/catalogue">Products</a>
          <span class="material-symbols-outlined text-[10px]">chevron_right</span>
          <span><%= pageTitle %></span>
        </div>
        <h1 class="text-xl font-bold text-gray-900 dark:text-white"><%= productName %></h1>
      </div>

      <div class="flex items-center gap-3">
        <button class="px-4 py-2 text-sm font-semibold border border-border-light dark:border-border-dark rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-all flex items-center gap-2" type="button" <%= liveUrl ? '' : 'disabled' %> onclick="if (this.disabled) return; window.open('<%= liveUrl || '' %>', '_blank', 'noopener');">
          <span class="material-symbols-outlined text-lg">visibility</span>
          View Live
        </button>

        <button class="px-6 py-2 text-sm font-semibold bg-primary hover:bg-primary-hover text-white rounded-lg shadow-sm transition-all flex items-center gap-2 disabled:opacity-50" form="productForm" type="submit" <%= dbConnected ? '' : 'disabled' %>>
          <span class="material-symbols-outlined text-lg">save</span>
          Save Changes
        </button>
      </div>
    </div>
  </header>

  <div class="p-8 max-w-6xl mx-auto space-y-8">
    <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
      <div class="rounded-xl border border-red-200 bg-red-50 p-4 text-red-900">
        <div class="font-bold">Erreur</div>
        <div class="mt-1 text-sm"><%= errorMessage %></div>
      </div>
    <% } %>

    <% if (!dbConnected) { %>
      <div class="rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
        <div class="font-bold">Mode démo</div>
        <div class="mt-1 text-sm">La base de données est indisponible : tu ne peux pas enregistrer de produit.</div>
      </div>
    <% } %>

    <form id="productForm" action="<%= mode === 'new' ? '/admin/catalogue/nouveau' : ('/admin/catalogue/' + productId) %>" enctype="multipart/form-data" method="POST" class="space-y-8">
      <section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
        <div class="p-6 border-b border-border-light dark:border-border-dark flex items-center justify-between">
          <h2 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-gray-400">info</span>
            General Information
          </h2>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="md:col-span-2">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="name">Product Title</label>
            <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="name" name="name" required type="text" value="<%= form && form.name ? form.name : '' %>" />
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="sku">SKU</label>
            <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="sku" name="sku" type="text" value="<%= form && form.sku ? form.sku : '' %>" />
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="price">Price (€)</label>
            <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="price" name="price" placeholder="Ex: 199,90" required type="text" value="<%= form && form.price ? form.price : '' %>" />
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="brand">Marque</label>
            <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="brand" name="brand" type="text" value="<%= form && form.brand ? form.brand : '' %>" />
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="category">Catégorie</label>
            <% if (typeof categories !== 'undefined' && categories && categories.length) { %>
              <select class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="category" name="category">
                <option value="">Autre</option>
                <% categories.forEach((c) => { %>
                  <option value="<%= c.name %>" <%= form && form.category === c.name ? 'selected' : '' %>><%= c.name %></option>
                <% }) %>
              </select>
            <% } else { %>
              <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="category" name="category" placeholder="Ex: Freinage" type="text" value="<%= form && form.category ? form.category : '' %>" />
            <% } %>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="shippingClassId">Classe d’expédition</label>
            <% if (typeof shippingClasses !== 'undefined' && shippingClasses && shippingClasses.length) { %>
              <select class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="shippingClassId" name="shippingClassId">
                <option value="">Par défaut</option>
                <% shippingClasses.forEach((c) => { %>
                  <% const optLabel = `${c.name || ''}${c.isDefault ? ' (défaut)' : ''}${c.isActive === false ? ' (inactive)' : ''}`; %>
                  <option value="<%= c.id %>" <%= form && form.shippingClassId === c.id ? 'selected' : '' %>><%= optLabel %></option>
                <% }) %>
              </select>
            <% } else { %>
              <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm opacity-70" disabled id="shippingClassId" name="shippingClassId" placeholder="Par défaut" type="text" value="Par défaut" />
            <% } %>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="compareAtPrice">Prix barré</label>
            <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="compareAtPrice" name="compareAtPrice" placeholder="Ex: 249,90" type="text" value="<%= form && form.compareAtPrice ? form.compareAtPrice : '' %>" />
          </div>

          <div class="md:col-span-4">
            <div class="flex items-center gap-3">
              <input class="rounded border-gray-300 text-primary focus:ring-primary" id="consigneEnabled" name="consigneEnabled" type="checkbox" <%= form && form.consigneEnabled ? 'checked' : '' %> />
              <label class="text-sm font-semibold text-gray-700 dark:text-gray-300" for="consigneEnabled">Activer la consigne (ancienne pièce à retourner)</label>
            </div>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-6">
              <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="consigneAmount">Montant consigne (€)</label>
                <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="consigneAmount" name="consigneAmount" placeholder="Ex: 150,00" type="text" value="<%= form && typeof form.consigneAmount !== 'undefined' ? form.consigneAmount : '' %>" />
              </div>
              <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="consigneDelayDays">Délai retour (jours)</label>
                <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="consigneDelayDays" name="consigneDelayDays" type="number" min="0" max="3650" value="<%= form && typeof form.consigneDelayDays !== 'undefined' ? form.consigneDelayDays : '30' %>" />
              </div>
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="stockQty">Stock</label>
            <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="stockQty" name="stockQty" placeholder="Laisse vide si non géré" type="number" min="0" value="<%= form && typeof form.stockQty !== 'undefined' ? form.stockQty : '' %>" />
          </div>

          <div class="flex items-center gap-3 md:col-span-4">
            <input class="rounded border-gray-300 text-primary focus:ring-primary" id="inStock" name="inStock" type="checkbox" <%= form && form.inStock ? 'checked' : '' %> />
            <label class="text-sm font-semibold text-gray-700 dark:text-gray-300" for="inStock">Produit en stock</label>
          </div>
        </div>
      </section>

      <input id="videoUrl" name="videoUrl" type="hidden" value="<%= form && form.videoUrl ? form.videoUrl : '' %>" />
      <textarea id="specs" name="specs" class="hidden"><%= form && form.specs ? form.specs : '' %></textarea>

      <section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
        <div class="p-6 border-b border-border-light dark:border-border-dark flex items-center justify-between">
          <h2 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-gray-400">imagesmode</span>
            Media Management
          </h2>
          <button class="text-primary text-sm font-bold flex items-center gap-1 hover:underline" id="mediaAddNew" type="button">
            <span class="material-symbols-outlined text-lg">add_a_photo</span>
            Add New
          </button>
        </div>

        <div class="p-6">
          <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-4" id="mediaGrid">
            <% if (form && form.imageUrl) { %>
              <div class="relative group aspect-square rounded-lg border border-primary overflow-hidden bg-white" data-kind="main" data-url="<%= form.imageUrl %>">
                <img alt="Product" class="w-full h-full object-cover" src="<%= form.imageUrl %>" />
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                  <button class="p-1.5 bg-white text-gray-900 rounded-full hover:text-primary" type="button"><span class="material-symbols-outlined text-sm">open_with</span></button>
                  <button class="p-1.5 bg-white text-gray-900 rounded-full hover:text-red-600" type="button" data-action="remove"><span class="material-symbols-outlined text-sm">delete</span></button>
                </div>
                <span class="absolute top-1 left-1 bg-primary text-white text-[8px] font-bold px-1.5 py-0.5 rounded">MAIN</span>
              </div>
            <% } %>

            <% (form && form.galleryUrls ? String(form.galleryUrls).split(/\r?\n/).map((s) => s.trim()).filter(Boolean) : []).forEach((u) => { %>
              <div class="relative group aspect-square rounded-lg border border-border-light dark:border-border-dark overflow-hidden bg-white" data-kind="gallery" data-url="<%= u %>">
                <img alt="Product" class="w-full h-full object-cover" src="<%= u %>" />
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                  <button class="p-1.5 bg-white text-gray-900 rounded-full" type="button"><span class="material-symbols-outlined text-sm">open_with</span></button>
                  <button class="p-1.5 bg-white text-gray-900 rounded-full" type="button" data-action="remove"><span class="material-symbols-outlined text-sm">delete</span></button>
                </div>
              </div>
            <% }) %>

            <button class="aspect-square rounded-lg border-2 border-dashed border-border-light dark:border-border-dark flex flex-col items-center justify-center text-gray-400 hover:border-primary hover:text-primary transition-all" id="mediaUploadBtn" type="button">
              <span class="material-symbols-outlined text-3xl mb-1">add</span>
              <span class="text-[10px] font-bold">UPLOAD</span>
            </button>
          </div>

          <input id="image" name="image" accept="image/*" type="file" multiple class="hidden" />
          <input id="imageUrl" name="imageUrl" type="hidden" value="<%= form && form.imageUrl ? form.imageUrl : '' %>" />
          <input id="removeMainImage" name="removeMainImage" type="hidden" value="false" />
          <textarea id="galleryUrls" name="galleryUrls" class="hidden"><%= form && form.galleryUrls ? form.galleryUrls : '' %></textarea>
        </div>
      </section>

      <section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm overflow-hidden">
        <div class="p-6 border-b border-border-light dark:border-border-dark flex items-center justify-between">
          <h2 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-gray-400">description</span>
            Description
          </h2>
        </div>

        <div class="p-6 space-y-6">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-border-light dark:border-border-dark flex flex-col items-center text-center">
              <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center mb-2">
                <span class="material-symbols-outlined">settings_input_component</span>
              </div>
              <span class="text-[10px] uppercase font-bold tracking-wider text-gray-400 mb-1">Badge haut</span>
              <span class="text-sm font-semibold"><%= form && form.badgeTopLeft ? form.badgeTopLeft : '—' %></span>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-border-light dark:border-border-dark flex flex-col items-center text-center">
              <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center mb-2">
                <span class="material-symbols-outlined">history</span>
              </div>
              <span class="text-[10px] uppercase font-bold tracking-wider text-gray-400 mb-1">État</span>
              <span class="text-sm font-semibold"><%= form && form.badgeCondition ? form.badgeCondition : '—' %></span>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-border-light dark:border-border-dark flex flex-col items-center text-center">
              <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center mb-2">
                <span class="material-symbols-outlined">cable</span>
              </div>
              <span class="text-[10px] uppercase font-bold tracking-wider text-gray-400 mb-1">SKU</span>
              <span class="text-sm font-semibold"><%= form && form.sku ? form.sku : '—' %></span>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-border-light dark:border-border-dark flex flex-col items-center text-center">
              <div class="w-10 h-10 rounded-full bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center mb-2">
                <span class="material-symbols-outlined">verified</span>
              </div>
              <span class="text-[10px] uppercase font-bold tracking-wider text-gray-400 mb-1">Catégorie</span>
              <span class="text-sm font-semibold"><%= form && form.category ? form.category : '—' %></span>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="specType">Type (Caractéristiques principales)</label>
              <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="specType" name="specType" type="text" placeholder="Ex: Boîte de vitesses" value="<%= specTypeValue %>" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="specProgrammation">Programmation (Caractéristiques principales)</label>
              <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="specProgrammation" name="specProgrammation" type="text" placeholder="Ex: Oui / Non / À coder" value="<%= specProgrammationValue %>" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="badgeTopLeft">Garantie (affiché sur la fiche produit)</label>
              <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="badgeTopLeft" name="badgeTopLeft" placeholder="Ex: Garantie 24 mois" type="text" value="<%= form && form.badgeTopLeft ? form.badgeTopLeft : '' %>" />
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="badgeCondition">État (affiché sur la fiche produit)</label>
              <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="badgeCondition" name="badgeCondition" placeholder="Ex: Reconditionné" type="text" value="<%= form && form.badgeCondition ? form.badgeCondition : '' %>" />
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="shortDescription">Résumé</label>
            <textarea class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary resize-none" id="shortDescription" name="shortDescription" rows="2"><%= form && form.shortDescription ? form.shortDescription : '' %></textarea>
          </div>

          <div class="border border-border-light dark:border-border-dark rounded-lg overflow-hidden">
            <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-2 border-b border-border-light dark:border-border-dark flex gap-2">
              <button class="p-1 hover:bg-white dark:hover:bg-gray-700 rounded" type="button"><span class="material-symbols-outlined text-lg">format_bold</span></button>
              <button class="p-1 hover:bg-white dark:hover:bg-gray-700 rounded" type="button"><span class="material-symbols-outlined text-lg">format_italic</span></button>
              <button class="p-1 hover:bg-white dark:hover:bg-gray-700 rounded" type="button"><span class="material-symbols-outlined text-lg">format_list_bulleted</span></button>
              <div class="w-px h-6 bg-border-light dark:bg-border-dark mx-1"></div>
              <button class="p-1 hover:bg-white dark:hover:bg-gray-700 rounded" type="button"><span class="material-symbols-outlined text-lg">link</span></button>
            </div>
            <textarea class="w-full bg-transparent border-none focus:ring-0 p-4 text-sm resize-none" id="description" name="description" placeholder="Description du produit..." rows="8"><%= form && form.description ? form.description : '' %></textarea>
          </div>
        </div>
      </section>

      <section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
        <div class="p-6 border-b border-border-light dark:border-border-dark flex items-center justify-between gap-4">
          <h2 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-gray-400">autorenew</span>
            Reconditioning Process Steps
          </h2>

          <button class="px-4 py-2 text-xs font-bold bg-gray-900 dark:bg-white dark:text-gray-900 text-white rounded-lg flex items-center gap-1 hover:bg-black transition-colors" id="stepsPrefillBtn" type="button">
            <span class="material-symbols-outlined text-sm">auto_fix</span>
            Pré-remplir (4 étapes)
          </button>
        </div>

        <div class="p-6 grid grid-cols-1 md:grid-cols-4 gap-6" id="stepsGrid">
          <% for (let i = 1; i <= 4; i += 1) { %>
            <div class="space-y-3" data-step>
              <div class="flex items-center justify-between">
                <span class="text-[10px] font-bold text-gray-400 uppercase">Step <%= i %></span>
                <button class="text-gray-400 hover:text-primary" type="button"><span class="material-symbols-outlined text-sm">settings</span></button>
              </div>
              <select class="w-full text-xs font-bold bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded p-2" data-step-title-select>
                <option value="">Choisir...</option>
                <option value="Diagnostic">Diagnostic</option>
                <option value="Nettoyage">Nettoyage</option>
                <option value="Remplacement">Remplacement</option>
                <option value="Test Banc">Test Banc</option>
                <option value="Programmation">Programmation</option>
                <option value="Contrôle Qualité">Contrôle Qualité</option>
                <option value="Garantie">Garantie</option>
                <option value="Expédition">Expédition</option>
                <option value="__custom__">Autre (personnalisé)</option>
              </select>
              <input class="w-full text-xs font-bold bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded p-2 hidden" type="text" data-step-title-custom placeholder="Titre personnalisé" />
              <textarea class="w-full text-xs bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded p-2 h-20" data-step-description></textarea>
            </div>
          <% } %>
        </div>

        <textarea id="reconditioningSteps" name="reconditioningSteps" class="hidden"><%= form && form.reconditioningSteps ? form.reconditioningSteps : '' %></textarea>
      </section>

      <section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
        <div class="p-6 border-b border-border-light dark:border-border-dark flex items-center justify-between">
          <h2 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-gray-400">directions_car</span>
            Compatibilité Véhicules
          </h2>
          <button class="text-primary text-sm font-bold flex items-center gap-1 hover:underline" id="compatAddBtn" type="button">
            <span class="material-symbols-outlined text-lg">add</span>
            Link New Model
          </button>
        </div>
        <div class="p-6 space-y-8">
          <div class="p-5 bg-primary/5 border border-primary/10 rounded-xl">
            <div class="flex flex-col md:flex-row items-center gap-4">
              <div class="flex-1">
                <h4 class="text-sm font-bold flex items-center gap-2">
                  <span class="material-symbols-outlined text-primary text-lg">verified</span>
                  Verify VIN Compatibility
                </h4>
                <p class="text-[11px] text-gray-500 mt-0.5">Test real-time matching with chassis numbers</p>
              </div>
              <div class="relative flex-1 w-full">
                <input class="w-full bg-white dark:bg-gray-900 border-primary rounded-lg py-2 pl-4 pr-10 text-sm focus:ring-0 uppercase font-mono tracking-widest" placeholder="WVWZZZ1KXXXXXXXXX" type="text" />
                <span class="material-symbols-outlined absolute right-3 top-2 text-green-600 hidden" id="vinCheckIcon">check_circle</span>
              </div>
              <div class="text-xs font-bold text-green-600 px-3 py-2 bg-green-50 rounded-lg border border-green-100 hidden md:block" id="vinMatchBox">
                MATCH FOUND
              </div>
            </div>
          </div>

          <div class="space-y-6">
            <div class="space-y-3">
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest">Select Brand to Manage</label>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2" for="compatMakeSelect">Marque</label>
                  <select class="w-full bg-white dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-3 text-sm" id="compatMakeSelect"></select>
                  <input class="w-full bg-white dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-3 text-sm hidden mt-2" id="compatMakeCustom" type="text" placeholder="Nouvelle marque (ex: Audi)" autocomplete="off" />
                </div>

                <div>
                  <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2" for="compatModelSelect">Modèle</label>
                  <select class="w-full bg-white dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-3 text-sm" id="compatModelSelect"></select>
                  <input class="w-full bg-white dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-3 text-sm hidden mt-2" id="compatModelCustom" type="text" placeholder="Nouveau modèle (ex: A3 (8V))" autocomplete="off" />
                </div>

                <div>
                  <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2" for="compatYears">Années</label>
                  <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-3 text-sm" id="compatYears" type="text" placeholder="Ex: 2012-2019" />
                </div>

                <div class="md:col-span-2">
                  <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2" for="compatEngine">Moteur</label>
                  <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-3 text-sm" id="compatEngine" type="text" placeholder="Ex: 1.0 / 1.4 / 1.5" />
                </div>

                <div class="md:col-span-2 flex items-end justify-end">
                  <button class="px-4 py-2 text-xs font-bold bg-gray-900 dark:bg-white dark:text-gray-900 text-white rounded-lg flex items-center gap-1 hover:bg-black transition-colors" id="compatAddItemBtn" type="button">
                    <span class="material-symbols-outlined text-sm">add</span>
                    Ajouter la compatibilité
                  </button>
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest" id="compatModelsLabel">Compatible Models</label>
              <div class="flex flex-wrap gap-3" id="compatModels"></div>
            </div>
          </div>
        </div>

        <textarea id="compatibility" name="compatibility" class="hidden"><%= form && form.compatibility ? form.compatibility : '' %></textarea>
      </section>

      <section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
        <div class="p-6 border-b border-border-light dark:border-border-dark flex items-center justify-between flex-wrap gap-4">
          <h2 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-gray-400">quiz</span>
            Questions Fréquentes
          </h2>
          <div class="flex items-center gap-3">
            <div class="relative w-64">
              <input class="w-full text-xs py-2 pl-9 pr-4 bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg focus:ring-primary focus:border-primary" placeholder="Search questions..." type="text" id="faqSearch" />
              <span class="material-symbols-outlined absolute left-2.5 top-1.5 text-gray-400 text-lg">search</span>
            </div>
            <button class="px-4 py-2 text-xs font-bold bg-gray-900 dark:bg-white dark:text-gray-900 text-white rounded-lg flex items-center gap-1 hover:bg-black transition-colors" id="faqAddBtn" type="button">
              <span class="material-symbols-outlined text-sm">add</span> Add New
            </button>
          </div>
        </div>

        <div class="p-6 space-y-1" id="faqList"></div>

        <textarea id="faqs" name="faqs" class="hidden"><%= form && form.faqs ? form.faqs : '' %></textarea>
      </section>

      <section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
        <div class="p-6 border-b border-border-light dark:border-border-dark flex items-center justify-between flex-wrap gap-4">
          <h2 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-gray-400">article</span>
            Articles de blog liés
          </h2>
          <div class="text-[11px] text-gray-500">Ces articles apparaîtront sur la fiche produit.</div>
        </div>

        <div class="p-6 space-y-4">
          <div>
            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest">Rechercher un article</label>
            <input
              id="relatedBlogSearch"
              class="mt-2 w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm"
              type="text"
              placeholder="Tape au moins 2 lettres (titre, slug, extrait...)"
              autocomplete="off"
            />
            <div id="relatedBlogResults" class="mt-2 max-h-56 overflow-auto rounded-xl border border-border-light dark:border-border-dark bg-white dark:bg-gray-900"></div>
          </div>

          <div>
            <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Sélection</div>
            <div id="relatedBlogSelected" class="mt-2 space-y-2"></div>
          </div>

          <textarea id="relatedBlogPostIds" class="hidden" name="relatedBlogPostIds" rows="4"><%= form && form.relatedBlogPostIds ? form.relatedBlogPostIds : '' %></textarea>
          <div class="text-xs text-gray-500">Astuce : si tu ne sélectionnes rien ici, tu peux quand même lier un produit depuis l’article (admin blog).</div>
        </div>
      </section>

      <section class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark shadow-sm">
        <div class="p-6 border-b border-border-light dark:border-border-dark">
          <h2 class="font-bold flex items-center gap-2">
            <span class="material-symbols-outlined text-gray-400">language</span>
            SEO &amp; Meta Tags
          </h2>
        </div>
        <div class="p-6 space-y-6">
          <% if (typeof seoAssistant !== 'undefined' && seoAssistant) { %>
            <div class="rounded-xl border border-border-light dark:border-border-dark bg-gray-50 dark:bg-gray-900/40 p-4">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Score SEO</div>
                  <div id="seoScoreValue" class="mt-1 text-2xl font-black text-gray-900 dark:text-white"><%= seoAssistant.score %>/100</div>
                </div>
                <div class="w-40">
                  <div class="h-2 rounded-full bg-gray-200 dark:bg-gray-800 overflow-hidden">
                    <div id="seoProgressFill" class="h-2 bg-primary" data-width="<%= Math.max(0, Math.min(100, seoAssistant.score)) %>"></div>
                  </div>
                  <div class="mt-2 text-[10px] font-bold text-gray-500">Objectif : 85+</div>
                </div>
              </div>

              <div class="mt-4">
                <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Prévisualisation Google</div>
                <div class="mt-2 rounded-xl border border-border-light dark:border-border-dark bg-white dark:bg-gray-900 p-4">
                  <div id="seoPreviewTitle" class="text-[#1a0dab] text-sm font-bold leading-snug"><%= seoAssistant.preview && seoAssistant.preview.title ? seoAssistant.preview.title : '' %></div>
                  <div id="seoPreviewUrl" class="mt-1 text-[11px] text-[#006621] break-all"><%= seoAssistant.preview && seoAssistant.preview.url ? seoAssistant.preview.url : '' %></div>
                  <div id="seoPreviewDescription" class="mt-2 text-[12px] text-gray-700 dark:text-gray-300 leading-snug"><%= seoAssistant.preview && seoAssistant.preview.description ? seoAssistant.preview.description : '' %></div>
                </div>
              </div>

              <div class="mt-4">
                <div class="text-[10px] font-black uppercase tracking-widest text-gray-400">Checklist</div>
                <div id="seoChecklist" class="mt-2 space-y-2">
                  <% (seoAssistant.checks || []).forEach((c) => { %>
                    <div class="flex items-start gap-2">
                      <span class="material-symbols-outlined text-base <%= c.ok ? 'text-green-600' : 'text-red-600' %>"><%= c.ok ? 'check_circle' : 'cancel' %></span>
                      <div class="flex-1">
                        <div class="text-xs font-bold text-gray-900 dark:text-white"><%= c.label %></div>
                        <% if (c.detail) { %>
                          <div class="mt-0.5 text-[11px] text-gray-500 dark:text-gray-400"><%= c.detail %></div>
                        <% } %>
                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
            </div>
          <% } %>

          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="metaTitle">Meta Title</label>
            <input class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary" id="metaTitle" name="metaTitle" type="text" value="<%= form && form.metaTitle ? form.metaTitle : '' %>" />
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2" for="metaDescription">Meta Description</label>
            <textarea class="w-full bg-gray-50 dark:bg-gray-900 border-border-light dark:border-border-dark rounded-lg py-2.5 px-4 text-sm focus:ring-primary focus:border-primary resize-none" id="metaDescription" name="metaDescription" rows="3"><%= form && form.metaDescription ? form.metaDescription : '' %></textarea>
          </div>
        </div>
      </section>
    </form>

    <script id="compatIndexJson" type="application/json"><%- JSON.stringify((typeof compatIndex !== 'undefined' && compatIndex) ? compatIndex : { makes: [], modelsByMake: {} }) %></script>

    <script id="seoAssistantSeed" type="application/json"><%- JSON.stringify({
      baseUrl: (seoAssistant && seoAssistant.computed && seoAssistant.computed.baseUrl) ? seoAssistant.computed.baseUrl : '',
      productId: productId ? String(productId) : 'ID',
    }) %></script>

    <script>
      (function () {
        const fileInput = document.getElementById('image');
        const addNewBtn = document.getElementById('mediaAddNew');
        const uploadBtn = document.getElementById('mediaUploadBtn');
        const grid = document.getElementById('mediaGrid');
        const galleryField = document.getElementById('galleryUrls');
        const canUseMedia = !!(fileInput && addNewBtn && uploadBtn && grid && galleryField);

        const selected = [];

        const sameFile = (a, b) => a && b && a.name === b.name && a.size === b.size && a.lastModified === b.lastModified;
        const syncInputFiles = () => {
          const dt = new DataTransfer();
          selected.forEach((f) => dt.items.add(f));
          fileInput.files = dt.files;
        };

        const openPicker = () => fileInput.click();
        if (canUseMedia) {
          addNewBtn.addEventListener('click', openPicker);
          uploadBtn.addEventListener('click', openPicker);
        }

        const removeGalleryUrl = (url) => {
          const lines = String(galleryField.value || '')
            .split(/\r?\n/)
            .map((s) => s.trim())
            .filter(Boolean);
          const next = lines.filter((l) => l !== url);
          galleryField.value = next.join('\n');
        };

        if (canUseMedia) {
          grid.addEventListener('click', (e) => {
            const btn = e.target && e.target.closest ? e.target.closest('button[data-action="remove"]') : null;
            if (!btn) return;
            const tile = btn.closest('[data-kind]');
            if (!tile) return;
            const kind = tile.getAttribute('data-kind');
            const url = tile.getAttribute('data-url') || '';
            const previewIdx = tile.getAttribute('data-preview-idx');
            if (previewIdx !== null && previewIdx !== '') {
              const idx = Number(previewIdx);
              if (Number.isFinite(idx) && idx >= 0 && idx < selected.length) {
                selected.splice(idx, 1);
                syncInputFiles();
              }
            } else if (kind === 'gallery' && url) {
              removeGalleryUrl(url);
            } else if (kind === 'main') {
              const imageUrlField = document.getElementById('imageUrl');
              if (imageUrlField && imageUrlField.value === url) imageUrlField.value = '';
              const removeMainImageField = document.getElementById('removeMainImage');
              if (removeMainImageField) removeMainImageField.value = 'true';
            }
            tile.remove();

            const previewTiles = Array.from(grid.querySelectorAll('[data-preview="true"]'));
            previewTiles.forEach((el, i) => el.setAttribute('data-preview-idx', String(i)));
          });
        }

        if (canUseMedia) fileInput.addEventListener('change', () => {
          const removeMainImageField = document.getElementById('removeMainImage');
          if (removeMainImageField) removeMainImageField.value = 'false';

          const files = Array.from(fileInput.files || []);
          files.forEach((f) => {
            if (selected.some((x) => sameFile(x, f))) return;
            selected.push(f);
          });
          syncInputFiles();

          Array.from(grid.querySelectorAll('[data-preview="true"]')).forEach((el) => el.remove());

          const beforeNode = uploadBtn;
          selected.forEach((f, idx) => {
            const url = URL.createObjectURL(f);
            const wrapper = document.createElement('div');
            wrapper.className = 'relative group aspect-square rounded-lg border border-border-light dark:border-border-dark overflow-hidden bg-white';
            wrapper.setAttribute('data-kind', 'preview');
            wrapper.setAttribute('data-preview', 'true');
            wrapper.setAttribute('data-preview-idx', String(idx));
            wrapper.setAttribute('data-url', url);

            const img = document.createElement('img');
            img.alt = 'Product';
            img.className = 'w-full h-full object-cover';
            img.src = url;

            const overlay = document.createElement('div');
            overlay.className = 'absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2';

            const moveBtn = document.createElement('button');
            moveBtn.type = 'button';
            moveBtn.className = 'p-1.5 bg-white text-gray-900 rounded-full';
            moveBtn.innerHTML = '<span class="material-symbols-outlined text-sm">open_with</span>';

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'p-1.5 bg-white text-gray-900 rounded-full';
            delBtn.setAttribute('data-action', 'remove');
            delBtn.innerHTML = '<span class="material-symbols-outlined text-sm">delete</span>';

            overlay.appendChild(moveBtn);
            overlay.appendChild(delBtn);
            wrapper.appendChild(img);
            wrapper.appendChild(overlay);
            grid.insertBefore(wrapper, beforeNode);
          });
        });

        const stepsGrid = document.getElementById('stepsGrid');
        const stepsField = document.getElementById('reconditioningSteps');
        const compatField = document.getElementById('compatibility');
        const compatMakeSelect = document.getElementById('compatMakeSelect');
        const compatMakeCustom = document.getElementById('compatMakeCustom');
        const compatModelSelect = document.getElementById('compatModelSelect');
        const compatModelCustom = document.getElementById('compatModelCustom');
        const compatYears = document.getElementById('compatYears');
        const compatEngine = document.getElementById('compatEngine');
        const compatAddItemBtn = document.getElementById('compatAddItemBtn');
        const compatModels = document.getElementById('compatModels');
        const compatModelsLabel = document.getElementById('compatModelsLabel');
        const compatAddBtn = document.getElementById('compatAddBtn');
        const faqField = document.getElementById('faqs');
        const faqList = document.getElementById('faqList');
        const faqAddBtn = document.getElementById('faqAddBtn');
        const faqSearch = document.getElementById('faqSearch');

        const compatIndexEl = document.getElementById('compatIndexJson');
        let SERVER_COMPAT_INDEX = { makes: [], modelsByMake: {} };
        try {
          SERVER_COMPAT_INDEX = compatIndexEl && compatIndexEl.textContent
            ? JSON.parse(compatIndexEl.textContent)
            : { makes: [], modelsByMake: {} };
        } catch (e) {
          SERVER_COMPAT_INDEX = { makes: [], modelsByMake: {} };
        }

        const seoSeedEl = document.getElementById('seoAssistantSeed');
        let SEO_SEED = { baseUrl: '', productId: 'ID' };
        try {
          SEO_SEED = seoSeedEl && seoSeedEl.textContent
            ? JSON.parse(seoSeedEl.textContent)
            : { baseUrl: '', productId: 'ID' };
        } catch (e) {
          SEO_SEED = { baseUrl: '', productId: 'ID' };
        }

        const DEFAULT_MAKES = [
          'Audi',
          'BMW',
          'Citroën',
          'Dacia',
          'Fiat',
          'Ford',
          'Hyundai',
          'Kia',
          'Mercedes',
          'Nissan',
          'Opel',
          'Peugeot',
          'Renault',
          'Seat',
          'Skoda',
          'Toyota',
          'Volkswagen',
          'Volvo',
        ];

        const parseLinesValue = (value) => String(value || '').split(/\r?\n/).map((s) => s.trim()).filter(Boolean);

        const specsField = document.getElementById('specs');
        const specTypeInput = document.getElementById('specType');
        const specProgrammationInput = document.getElementById('specProgrammation');

        const parseSpecPairs = (value) => {
          const lines = parseLinesValue(value);
          const pairs = [];

          lines.forEach((line) => {
            const sepIndex = line.indexOf(':') >= 0
              ? line.indexOf(':')
              : (line.indexOf('=') >= 0 ? line.indexOf('=') : line.indexOf('|'));
            if (sepIndex <= 0) return;

            const label = line.slice(0, sepIndex).trim();
            const val = line.slice(sepIndex + 1).trim();
            if (!label || !val) return;

            pairs.push({ label, value: val });
          });

          return pairs;
        };

        const upsertSpec = (pairs, key, displayLabel, value) => {
          const k = String(key || '').toLowerCase();
          const v = String(value || '').trim();
          const idx = pairs.findIndex((p) => p && p.label && String(p.label).trim().toLowerCase() === k);

          if (!v) {
            if (idx >= 0) pairs.splice(idx, 1);
            return;
          }

          if (idx >= 0) pairs[idx].value = v;
          else pairs.push({ label: displayLabel, value: v });
        };

        const syncSpecsFromKeyFields = () => {
          if (!specsField) return;
          const pairs = parseSpecPairs(specsField.value);
          if (specTypeInput) upsertSpec(pairs, 'type', 'Type', specTypeInput.value);
          if (specProgrammationInput) upsertSpec(pairs, 'programmation', 'Programmation', specProgrammationInput.value);
          specsField.value = pairs.map((p) => `${p.label}: ${p.value}`.trim()).filter(Boolean).join('\n');
        };

        if (specsField && (specTypeInput || specProgrammationInput)) {
          if (specTypeInput) specTypeInput.addEventListener('input', syncSpecsFromKeyFields);
          if (specProgrammationInput) specProgrammationInput.addEventListener('input', syncSpecsFromKeyFields);
          syncSpecsFromKeyFields();
        }

        const parseSteps = () => {
          const lines = parseLinesValue(stepsField ? stepsField.value : '');
          const out = [];
          lines.forEach((line) => {
            const idx = line.indexOf(':');
            if (idx === -1) return;
            const title = line.slice(0, idx).trim();
            const description = line.slice(idx + 1).trim();
            if (!title && !description) return;
            out.push({ title, description });
          });
          while (out.length < 4) out.push({ title: '', description: '' });
          return out.slice(0, 4);
        };

        const syncStepsField = () => {
          if (!stepsField || !stepsGrid) return;
          const blocks = Array.from(stepsGrid.querySelectorAll('[data-step]'));
          const lines = blocks
            .map((b) => {
              const sel = b.querySelector('[data-step-title-select]');
              const custom = b.querySelector('[data-step-title-custom]');
              const selValue = sel && sel.value ? String(sel.value) : '';
              const t = selValue === '__custom__'
                ? ((custom || {}).value || '')
                : selValue;
              const d = (b.querySelector('[data-step-description]') || {}).value || '';
              const title = String(t).trim();
              const desc = String(d).trim();
              if (!title && !desc) return '';
              return `${title}: ${desc}`.trim();
            })
            .filter(Boolean);
          stepsField.value = lines.join('\n');
        };

        if (stepsGrid && stepsField) {
          const STEP_PRESETS = {
            Diagnostic: 'Contrôle visuel et lecture des défauts initiaux.',
            Nettoyage: 'Démontage complet et nettoyage ultrason.',
            Remplacement: 'Électrovannes, joints et capteurs critiques changés.',
            'Test Banc': 'Simulation conditions réelles et programmation.',
          };

          const applyStepTitle = (block, title) => {
            const sel = block ? block.querySelector('[data-step-title-select]') : null;
            const custom = block ? block.querySelector('[data-step-title-custom]') : null;
            const exists = sel ? Array.from(sel.options || []).some((o) => o && o.value === title) : false;

            if (!sel) return;

            if (exists || title === '') {
              sel.value = title;
              if (custom) {
                custom.classList.add('hidden');
                custom.value = '';
              }
              return;
            }

            sel.value = '__custom__';
            if (custom) {
              custom.classList.remove('hidden');
              custom.value = title;
            }
          };

          const applyPresetSteps = () => {
            const blocks = Array.from(stepsGrid.querySelectorAll('[data-step]'));
            const titles = ['Diagnostic', 'Nettoyage', 'Remplacement', 'Test Banc'];

            blocks.slice(0, 4).forEach((b, i) => {
              const title = titles[i] || '';
              applyStepTitle(b, title);
              const d = b.querySelector('[data-step-description]');
              if (d) d.value = STEP_PRESETS[title] || '';
            });

            syncStepsField();
          };

          const stepsPrefillBtn = document.getElementById('stepsPrefillBtn');
          if (stepsPrefillBtn) {
            stepsPrefillBtn.addEventListener('click', () => {
              const current = String(stepsField.value || '').trim();
              if (current) {
                const ok = window.confirm('Remplacer les étapes déjà remplies par le modèle (4 étapes) ?');
                if (!ok) return;
              }
              applyPresetSteps();
            });
          }

          const initial = parseSteps();
          const blocks = Array.from(stepsGrid.querySelectorAll('[data-step]'));
          blocks.forEach((b, i) => {
            const sel = b.querySelector('[data-step-title-select]');
            const custom = b.querySelector('[data-step-title-custom]');
            const d = b.querySelector('[data-step-description]');
            const initialTitle = initial[i] ? String(initial[i].title || '').trim() : '';

            if (sel) {
              const exists = Array.from(sel.options || []).some((o) => o && o.value === initialTitle);
              if (exists || initialTitle === '') {
                sel.value = initialTitle;
                if (custom) custom.classList.add('hidden');
              } else {
                sel.value = '__custom__';
                if (custom) {
                  custom.classList.remove('hidden');
                  custom.value = initialTitle;
                }
              }
            }
            if (d) d.value = initial[i] ? initial[i].description : '';
          });
          stepsGrid.addEventListener('input', syncStepsField);
          stepsGrid.addEventListener('change', (e) => {
            const target = e && e.target ? e.target : null;
            if (!target) return;
            if (target.matches && target.matches('[data-step-title-select]')) {
              const block = target.closest('[data-step]');
              if (!block) return;
              const custom = block.querySelector('[data-step-title-custom]');
              if (!custom) return;
              if (String(target.value) === '__custom__') custom.classList.remove('hidden');
              else custom.classList.add('hidden');

              const selectedTitle = String(target.value || '').trim();
              const descField = block.querySelector('[data-step-description]');
              const currentDesc = descField ? String(descField.value || '').trim() : '';
              if (descField && !currentDesc && STEP_PRESETS[selectedTitle]) {
                descField.value = STEP_PRESETS[selectedTitle];
              }

              syncStepsField();
            }
          });
        }

        const parseCompatibility = () => {
          const lines = parseLinesValue(compatField ? compatField.value : '');
          return lines
            .map((line) => {
              const parts = line.split('|').map((p) => String(p || '').trim());
              return {
                make: parts[0] || '',
                model: parts[1] || '',
                years: parts[2] || '',
                engine: parts[3] || '',
              };
            })
            .filter((x) => x.make || x.model || x.years || x.engine);
        };

        const syncCompatibilityField = (items) => {
          if (!compatField) return;
          compatField.value = items
            .map((x) => `${x.make} | ${x.model} | ${x.years} | ${x.engine}`.trim())
            .join('\n');

          if (typeof updateSeoAssistant === 'function') updateSeoAssistant();
        };

        let compatItems = parseCompatibility();
        let selectedMake = compatItems.length ? (compatItems[0].make || '') : '';

        const makeList = () => {
          const fromData = compatItems.map((x) => x.make).filter(Boolean);
          const fromServer = SERVER_COMPAT_INDEX && Array.isArray(SERVER_COMPAT_INDEX.makes) ? SERVER_COMPAT_INDEX.makes : [];
          const all = Array.from(new Set([...DEFAULT_MAKES, ...fromServer, ...fromData])).sort((a, b) => String(a).localeCompare(String(b), 'fr'));
          return all;
        };

        const resolveMakeKey = (value) => {
          const raw = String(value || '').trim();
          if (!raw) return '';
          const low = raw.toLowerCase();
          const all = makeList();
          const exact = all.find((m) => String(m).toLowerCase() === low);
          return exact || raw;
        };

        const setSelectMakeOptions = (select, values) => {
          if (!select) return;
          const current = select.value;
          select.innerHTML = '';

          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Choisir une marque...';
          select.appendChild(placeholder);

          values.forEach((v) => {
            const o = document.createElement('option');
            o.value = v;
            o.textContent = v;
            select.appendChild(o);
          });

          const custom = document.createElement('option');
          custom.value = '__custom__';
          custom.textContent = 'Autre (nouvelle marque)';
          select.appendChild(custom);

          if (current) select.value = current;
        };

        const setSelectModelOptions = (select, values) => {
          if (!select) return;
          const current = select.value;
          select.innerHTML = '';

          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Choisir un modèle...';
          select.appendChild(placeholder);

          values.forEach((v) => {
            const o = document.createElement('option');
            o.value = v;
            o.textContent = v;
            select.appendChild(o);
          });

          const custom = document.createElement('option');
          custom.value = '__custom__';
          custom.textContent = 'Autre (nouveau modèle)';
          select.appendChild(custom);

          if (current) select.value = current;
        };

        const modelsForMake = (mk) => {
          const fromData = compatItems
            .filter((x) => x.make && mk && x.make === mk && x.model)
            .map((x) => x.model);
          const fromServer = SERVER_COMPAT_INDEX && SERVER_COMPAT_INDEX.modelsByMake && SERVER_COMPAT_INDEX.modelsByMake[mk]
            ? SERVER_COMPAT_INDEX.modelsByMake[mk]
            : [];
          const all = Array.from(new Set([...(Array.isArray(fromServer) ? fromServer : []), ...fromData]))
            .sort((a, b) => String(a).localeCompare(String(b), 'fr'));
          return all;
        };

        const renderModelsList = () => {
          if (!compatModels || !compatModelsLabel) return;
          compatModelsLabel.textContent = selectedMake ? `Compatible Models (${selectedMake})` : 'Compatible Models';
          compatModels.innerHTML = '';
          const models = compatItems.filter((x) => (selectedMake ? x.make === selectedMake : true));
          models.forEach((x, idx) => {
            const card = document.createElement('div');
            card.className = 'group px-4 py-3 bg-white dark:bg-gray-900 border border-border-light dark:border-border-dark rounded-xl hover:shadow-md transition-all relative' + (idx === 0 ? ' border-l-4 border-l-primary' : '');
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between gap-4';
            const left = document.createElement('div');
            const title = document.createElement('p');
            title.className = 'font-bold text-sm';
            title.textContent = x.model || '(Sans modèle)';
            const sub = document.createElement('p');
            sub.className = 'text-[10px] text-gray-500';
            sub.textContent = x.engine || x.years || '';
            left.appendChild(title);
            left.appendChild(sub);
            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'opacity-0 group-hover:opacity-100 text-gray-400 hover:text-primary transition-opacity';
            del.innerHTML = '<span class="material-symbols-outlined text-lg">delete</span>';
            del.addEventListener('click', () => {
              const realIdx = compatItems.findIndex((it) => it === x);
              if (realIdx === -1) return;
              compatItems.splice(realIdx, 1);
              syncCompatibilityField(compatItems);
              renderCompatibilityUI();
            });
            row.appendChild(left);
            row.appendChild(del);
            card.appendChild(row);
            compatModels.appendChild(card);
          });
        };

        const renderCompatibilityUI = () => {
          if (!compatMakeSelect || !compatModelSelect) return;
          const makes = makeList();
          setSelectMakeOptions(compatMakeSelect, makes);

          let canonicalMake = '';
          if (compatMakeSelect.value === '__custom__') {
            if (compatMakeCustom) compatMakeCustom.classList.remove('hidden');
            canonicalMake = resolveMakeKey(String((compatMakeCustom || {}).value || '').trim());
          } else {
            if (compatMakeCustom) compatMakeCustom.classList.add('hidden');
            canonicalMake = resolveMakeKey(String(compatMakeSelect.value || '').trim());
          }

          if (canonicalMake) selectedMake = canonicalMake;

          const models = canonicalMake ? modelsForMake(canonicalMake) : [];
          setSelectModelOptions(compatModelSelect, models);

          if (compatModelSelect.value !== '__custom__') {
            if (compatModelCustom) compatModelCustom.classList.add('hidden');
          } else {
            if (compatModelCustom) compatModelCustom.classList.remove('hidden');
          }

          renderModelsList();
        };

        const readMakeFromUI = () => {
          if (!compatMakeSelect) return '';
          if (compatMakeSelect.value === '__custom__') return resolveMakeKey(String((compatMakeCustom || {}).value || '').trim());
          return resolveMakeKey(String(compatMakeSelect.value || '').trim());
        };
        const readModelFromUI = () => {
          if (!compatModelSelect) return '';
          if (compatModelSelect.value === '__custom__') return String((compatModelCustom || {}).value || '').trim();
          return String(compatModelSelect.value || '').trim();
        };

        if (compatMakeSelect) {
          compatMakeSelect.addEventListener('change', () => {
            selectedMake = readMakeFromUI();
            if (compatModelSelect) compatModelSelect.value = '';
            if (compatModelCustom) {
              compatModelCustom.value = '';
              compatModelCustom.classList.add('hidden');
            }

            if (compatMakeSelect.value !== '__custom__') {
              if (compatMakeCustom) {
                compatMakeCustom.value = '';
                compatMakeCustom.classList.add('hidden');
              }
            } else {
              if (compatMakeCustom) compatMakeCustom.classList.remove('hidden');
              if (compatMakeCustom) compatMakeCustom.focus();
            }

            renderCompatibilityUI();
          });
        }

        if (compatMakeCustom) {
          compatMakeCustom.addEventListener('input', () => {
            selectedMake = readMakeFromUI();
            if (compatModelSelect) compatModelSelect.value = '';
            if (compatModelCustom) {
              compatModelCustom.value = '';
              compatModelCustom.classList.add('hidden');
            }
            renderCompatibilityUI();
          });
        }
        if (compatModelSelect) {
          compatModelSelect.addEventListener('change', () => {
            if (compatModelSelect.value !== '__custom__') {
              if (compatModelCustom) {
                compatModelCustom.value = '';
                compatModelCustom.classList.add('hidden');
              }
            } else {
              if (compatModelCustom) compatModelCustom.classList.remove('hidden');
              if (compatModelCustom) compatModelCustom.focus();
            }
            renderCompatibilityUI();
          });
        }
        if (compatModelCustom) {
          compatModelCustom.addEventListener('input', renderCompatibilityUI);
        }

        if (compatAddItemBtn) {
          compatAddItemBtn.addEventListener('click', () => {
            const make = readMakeFromUI();
            const model = readModelFromUI();
            const years = String((compatYears || {}).value || '').trim();
            const engine = String((compatEngine || {}).value || '').trim();

            if (!make) {
              window.alert('Choisis une marque (ou ajoute une nouvelle marque).');
              if (compatMakeSelect) compatMakeSelect.focus();
              return;
            }

            if (!model) {
              window.alert('Choisis un modèle (ou ajoute un nouveau modèle).');
              if (compatModelSelect && compatModelSelect.value !== '__custom__') compatModelSelect.focus();
              else if (compatModelCustom) compatModelCustom.focus();
              return;
            }

            compatItems.push({ make, model, years, engine });
            syncCompatibilityField(compatItems);
            selectedMake = make;

            if (compatYears) compatYears.value = '';
            if (compatEngine) compatEngine.value = '';
            if (compatMakeSelect) compatMakeSelect.value = make;
            if (compatMakeCustom) {
              compatMakeCustom.value = '';
              compatMakeCustom.classList.add('hidden');
            }
            if (compatModelSelect) compatModelSelect.value = '';
            if (compatModelCustom) {
              compatModelCustom.value = '';
              compatModelCustom.classList.add('hidden');
            }

            renderCompatibilityUI();
          });
        }

        if (compatAddBtn) {
          compatAddBtn.addEventListener('click', () => {
            if (compatMakeSelect) compatMakeSelect.focus();
          });
        }

        if (compatMakeSelect && compatModelSelect) {
          if (selectedMake && !compatMakeSelect.value) {
            const hasMakeInList = makeList().some((m) => String(m) === String(selectedMake));
            if (hasMakeInList) {
              compatMakeSelect.value = selectedMake;
            } else {
              compatMakeSelect.value = '__custom__';
              if (compatMakeCustom) {
                compatMakeCustom.classList.remove('hidden');
                compatMakeCustom.value = selectedMake;
              }
            }
          }

          renderCompatibilityUI();
        }

        const parseFaqs = () => {
          const lines = parseLinesValue(faqField ? faqField.value : '');
          return lines
            .map((line) => {
              const parts = line.split('|').map((p) => String(p || '').trim());
              return { tag: 'FAQ', question: parts[0] || '', answer: parts[1] || '' };
            })
            .filter((x) => x.question || x.answer);
        };

        const syncFaqField = (items) => {
          if (!faqField) return;
          faqField.value = items.map((x) => `${x.question} | ${x.answer}`.trim()).join('\n');

          if (typeof updateSeoAssistant === 'function') updateSeoAssistant();
        };

        let faqItems = parseFaqs();

        const renderFaqs = () => {
          if (!faqList) return;
          const q = faqSearch ? String(faqSearch.value || '').trim().toLowerCase() : '';
          const filtered = q
            ? faqItems.filter((x) => (`${x.question} ${x.answer}`).toLowerCase().includes(q))
            : faqItems;

          faqList.innerHTML = '';
          filtered.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'group py-4 border-b border-gray-100 dark:border-gray-800 last:border-0 hover:bg-gray-50/50 dark:hover:bg-gray-800/30 transition-colors px-4 -mx-4 rounded-lg';

            const top = document.createElement('div');
            top.className = 'flex items-start justify-between';

            const left = document.createElement('div');
            left.className = 'space-y-2 flex-1';
            const hrow = document.createElement('div');
            hrow.className = 'flex items-center gap-2';
            const tag = document.createElement('span');
            tag.className = 'text-[10px] font-bold text-primary uppercase';
            tag.textContent = item.tag;
            const title = document.createElement('h4');
            title.className = 'font-semibold text-sm';
            title.textContent = item.question;
            hrow.appendChild(tag);
            hrow.appendChild(title);
            const desc = document.createElement('p');
            desc.className = 'text-xs text-gray-500 dark:text-gray-400 line-clamp-1';
            desc.textContent = item.answer;
            left.appendChild(hrow);
            left.appendChild(desc);

            const actions = document.createElement('div');
            actions.className = 'flex items-center gap-2 ml-4';

            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'p-2 text-gray-400 hover:text-primary hover:bg-white dark:hover:bg-gray-700 rounded-lg transition-all';
            editBtn.innerHTML = '<span class="material-symbols-outlined text-lg">edit</span>';
            editBtn.addEventListener('click', () => {
              const qv = window.prompt('Question', item.question);
              if (qv === null) return;
              const av = window.prompt('Réponse', item.answer);
              if (av === null) return;
              item.question = String(qv).trim();
              item.answer = String(av).trim();
              syncFaqField(faqItems);
              renderFaqs();
            });

            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'p-2 text-gray-400 hover:text-red-600 hover:bg-white dark:hover:bg-gray-700 rounded-lg transition-all';
            delBtn.innerHTML = '<span class="material-symbols-outlined text-lg">delete</span>';
            delBtn.addEventListener('click', () => {
              const idx = faqItems.findIndex((x) => x === item);
              if (idx === -1) return;
              faqItems.splice(idx, 1);
              syncFaqField(faqItems);
              renderFaqs();
            });

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            top.appendChild(left);
            top.appendChild(actions);
            row.appendChild(top);
            faqList.appendChild(row);
          });
        };

        if (faqAddBtn) {
          faqAddBtn.addEventListener('click', () => {
            const qv = window.prompt('Question');
            if (!qv) return;
            const av = window.prompt('Réponse') || '';
            faqItems.push({ tag: 'FAQ', question: String(qv).trim(), answer: String(av).trim() });
            syncFaqField(faqItems);
            renderFaqs();
          });
        }
        if (faqSearch) {
          faqSearch.addEventListener('input', renderFaqs);
        }
        if (faqField && faqList) {
          renderFaqs();
        }

        var scoreValueEl = document.getElementById('seoScoreValue');
        var fill = document.getElementById('seoProgressFill');
        var previewTitleEl = document.getElementById('seoPreviewTitle');
        var previewUrlEl = document.getElementById('seoPreviewUrl');
        var previewDescEl = document.getElementById('seoPreviewDescription');
        var checklistEl = document.getElementById('seoChecklist');

        function normalizeMetaText(value) {
          return String(value || '').replace(/[\r\n\t]+/g, ' ').replace(/\s{2,}/g, ' ').trim();
        }

        function stripHtml(value) {
          return String(value || '').replace(/<[^>]*>/g, ' ').replace(/\s{2,}/g, ' ').trim();
        }

        function stripMarkdown(value) {
          return String(value || '')
            .replace(/\*\*([^*]+)\*\*/g, '$1')
            .replace(/`([^`]+)`/g, '$1')
            .replace(/^\s*[-*]\s+/gm, '')
            .replace(/^\s*\d+[).]\s+/gm, '')
            .replace(/\s{2,}/g, ' ')
            .trim();
        }

        function countWords(value) {
          var plain = stripMarkdown(stripHtml(value));
          if (!plain) return 0;
          return plain.split(/\s+/).filter(Boolean).length;
        }

        function truncateText(value, max) {
          var s = String(value || '').trim();
          if (!s) return '';
          if (!Number.isFinite(max) || max <= 0) return s;
          if (s.length <= max) return s;
          return s.slice(0, Math.max(0, max - 1)).trim() + '…';
        }

        function slugify(value) {
          var s = String(value || '');
          try {
            s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
          } catch (e) {}
          return s
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+/, '')
            .replace(/-+$/, '');
        }

        function updateSeoAssistant() {
          if (!scoreValueEl || !previewTitleEl || !previewUrlEl || !previewDescEl || !checklistEl) return;

          var siteName = 'CarParts France';
          var nameEl = document.getElementById('name');
          var skuEl = document.getElementById('sku');
          var brandEl = document.getElementById('brand');
          var categoryEl = document.getElementById('category');
          var imageUrlEl = document.getElementById('imageUrl');
          var galleryUrlsEl = document.getElementById('galleryUrls');
          var shortDescEl = document.getElementById('shortDescription');
          var descEl = document.getElementById('description');
          var metaTitleEl = document.getElementById('metaTitle');
          var metaDescEl = document.getElementById('metaDescription');
          var faqsEl = document.getElementById('faqs');
          var compatEl = document.getElementById('compatibility');

          var name = String((nameEl || {}).value || '').trim();
          var sku = String((skuEl || {}).value || '').trim();
          var brand = String((brandEl || {}).value || '').trim();
          var category = String((categoryEl || {}).value || '').trim();
          var imageUrl = String((imageUrlEl || {}).value || '').trim();
          var galleryUrls = String((galleryUrlsEl || {}).value || '').trim();
          var shortDescription = String((shortDescEl || {}).value || '').trim();
          var description = String((descEl || {}).value || '').trim();
          var metaTitle = normalizeMetaText(String((metaTitleEl || {}).value || ''));
          var metaDescription = normalizeMetaText(String((metaDescEl || {}).value || ''));
          var faqsText = String((faqsEl || {}).value || '');
          var compatText = String((compatEl || {}).value || '');

          var galleryCount = parseLinesValue(galleryUrls).length + (imageUrl ? 1 : 0);
          var words = countWords(description || shortDescription);
          var faqCount = parseLinesValue(faqsText).filter(function (l) { return l.indexOf('|') !== -1; }).length;
          var compatCount = parseLinesValue(compatText).filter(function (l) { return l.indexOf('|') !== -1; }).length;
          var hasRef = !!sku || /\b[A-Z0-9]{5,}\b/i.test(name);

          var urlId = (SEO_SEED && SEO_SEED.productId) ? SEO_SEED.productId : 'ID';
          var urlPath = '/produits/' + encodeURIComponent(slugify(name) || 'produit') + '-' + encodeURIComponent(String(urlId));
          var baseUrl = (SEO_SEED && SEO_SEED.baseUrl) ? SEO_SEED.baseUrl : '';
          var url = baseUrl ? (String(baseUrl).replace(/\/$/, '') + urlPath) : urlPath;

          var autoTitle = ((name || siteName)
            + (brand ? ' - ' + brand : '')
            + (sku ? ' (Réf ' + sku + ')' : '')
            + ' | ' + siteName).trim();
          var finalTitle = metaTitle || autoTitle;

          var fallbackDesc = truncateText(stripMarkdown(stripHtml(shortDescription || description)), 160);
          var finalDesc = metaDescription || fallbackDesc;

          var checks = [];
          checks.push({ key: 'name', label: 'Nom du produit', ok: !!name, detail: name ? '' : 'Ajoute un nom clair (idéalement avec la référence OEM).', weight: 20 });
          checks.push({ key: 'brand', label: 'Marque', ok: !!brand, detail: brand ? '' : 'Ajoute la marque (Volkswagen, Audi…).', weight: 5 });
          checks.push({ key: 'category', label: 'Catégorie', ok: !!category, detail: category ? '' : 'Choisis une catégorie.', weight: 5 });
          checks.push({ key: 'ref', label: 'Référence (SKU / OEM) présente', ok: hasRef, detail: hasRef ? '' : 'Ajoute un SKU ou une référence OEM dans le nom.', weight: 8 });
          checks.push({
            key: 'metaTitle',
            label: 'Meta title (50–60 caractères)',
            ok: finalTitle.length >= 45 && finalTitle.length <= 65,
            detail: metaTitle ? ('Longueur actuelle : ' + finalTitle.length) : ('Auto : ' + finalTitle.length + ' (tu peux optimiser)'),
            weight: 10,
          });
          checks.push({
            key: 'metaDescription',
            label: 'Meta description (120–160 caractères)',
            ok: finalDesc.length >= 110 && finalDesc.length <= 170,
            detail: metaDescription ? ('Longueur actuelle : ' + finalDesc.length) : ('Auto : ' + finalDesc.length + ' (tu peux optimiser)'),
            weight: 10,
          });
          checks.push({ key: 'image', label: 'Image principale', ok: !!imageUrl, detail: imageUrl ? '' : 'Ajoute une image principale (important pour le clic).', weight: 10 });
          checks.push({ key: 'gallery', label: 'Plusieurs images (2+)', ok: galleryCount >= 2, detail: 'Images détectées : ' + galleryCount, weight: 4 });
          checks.push({ key: 'content', label: 'Description suffisante (200+ mots)', ok: words >= 200, detail: 'Mots : ' + words, weight: 12 });
          checks.push({ key: 'faq', label: 'FAQ (4+ questions)', ok: faqCount >= 4, detail: 'FAQ : ' + faqCount, weight: 10 });
          checks.push({ key: 'compat', label: 'Compatibilité (3+ lignes)', ok: compatCount >= 3, detail: 'Compatibilités : ' + compatCount, weight: 8 });

          var score = 100;
          checks.forEach(function (c) { if (!c.ok) score -= (Number.isFinite(c.weight) ? c.weight : 10); });
          if (score < 0) score = 0;
          if (score > 100) score = 100;

          scoreValueEl.textContent = String(score) + '/100';
          previewTitleEl.textContent = finalTitle;
          previewUrlEl.textContent = url;
          previewDescEl.textContent = finalDesc;

          if (fill) {
            var w = Math.max(0, Math.min(100, score));
            fill.style.width = w + '%';
            fill.setAttribute('data-width', String(w));
          }

          checklistEl.innerHTML = '';
          checks.forEach(function (c) {
            var row = document.createElement('div');
            row.className = 'flex items-start gap-2';

            var icon = document.createElement('span');
            icon.className = 'material-symbols-outlined text-base ' + (c.ok ? 'text-green-600' : 'text-red-600');
            icon.textContent = c.ok ? 'check_circle' : 'cancel';

            var right = document.createElement('div');
            right.className = 'flex-1';

            var title = document.createElement('div');
            title.className = 'text-xs font-bold text-gray-900 dark:text-white';
            title.textContent = c.label;

            right.appendChild(title);
            if (c.detail) {
              var detail = document.createElement('div');
              detail.className = 'mt-0.5 text-[11px] text-gray-500 dark:text-gray-400';
              detail.textContent = c.detail;
              right.appendChild(detail);
            }

            row.appendChild(icon);
            row.appendChild(right);
            checklistEl.appendChild(row);
          });
        }

        updateSeoAssistant();
        ['name', 'sku', 'brand', 'category', 'imageUrl', 'galleryUrls', 'shortDescription', 'description', 'metaTitle', 'metaDescription', 'faqs', 'compatibility'].forEach(function (id) {
          var el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('input', updateSeoAssistant);
          el.addEventListener('change', updateSeoAssistant);
        });

        function fetchJson(url, cb) {
          fetch(url, { headers: { 'Accept': 'application/json' } })
            .then(function (r) { return r.json(); })
            .then(function (data) { cb(null, data); })
            .catch(function (err) { cb(err); });
        }

        function setupRelatedBlogPostsPicker() {
          var searchInput = document.getElementById('relatedBlogSearch');
          var resultsEl = document.getElementById('relatedBlogResults');
          var selectedEl = document.getElementById('relatedBlogSelected');
          var idsTextarea = document.getElementById('relatedBlogPostIds');

          if (!searchInput || !resultsEl || !selectedEl || !idsTextarea) return;

          function getSelectedIds() {
            return String(idsTextarea.value || '')
              .split(/\r?\n/)
              .map(function (s) { return String(s || '').trim(); })
              .filter(Boolean);
          }

          function setSelectedIds(ids) {
            idsTextarea.value = (ids || []).join('\n');
            if (typeof updateSeoAssistant === 'function') updateSeoAssistant();
          }

          function badge(html) {
            var wrap = document.createElement('span');
            wrap.className = 'inline-flex items-center rounded-full px-2 py-1 text-[10px] font-black uppercase tracking-widest bg-slate-100 text-slate-700';
            wrap.innerHTML = html;
            return wrap;
          }

          function renderSelected(itemsById) {
            var ids = getSelectedIds();
            selectedEl.innerHTML = '';
            ids.forEach(function (id) {
              var it = itemsById && itemsById[id] ? itemsById[id] : null;

              var row = document.createElement('div');
              row.className = 'flex items-center justify-between gap-3 rounded-xl border border-border-light dark:border-border-dark bg-white dark:bg-gray-900 px-4 py-3';

              var left = document.createElement('div');
              left.className = 'min-w-0';

              var title = document.createElement('div');
              title.className = 'font-bold text-sm text-gray-900 dark:text-white truncate';
              title.textContent = it ? (it.title || it.slug || id) : id;

              var meta = document.createElement('div');
              meta.className = 'mt-1 text-[11px] text-gray-500 truncate';
              meta.textContent = it ? ((it.categoryLabel ? it.categoryLabel : 'Blog') + (it.isPublished ? ' • publié' : ' • brouillon')) : '';

              left.appendChild(title);
              left.appendChild(meta);

              var del = document.createElement('button');
              del.type = 'button';
              del.className = 'text-gray-400 hover:text-red-600 transition-colors';
              del.innerHTML = '<span class="material-symbols-outlined">close</span>';
              del.addEventListener('click', function () {
                var next = getSelectedIds().filter(function (x) { return x !== id; });
                setSelectedIds(next);
                hydrateSelected();
              });

              row.appendChild(left);
              row.appendChild(del);
              selectedEl.appendChild(row);
            });
          }

          function hydrateSelected() {
            var ids = getSelectedIds();
            if (!ids.length) {
              selectedEl.innerHTML = '<div class="text-xs text-gray-500">Aucun article lié.</div>';
              return;
            }

            var url = '/admin/api/blog/search?ids=' + encodeURIComponent(ids.join(','));
            fetchJson(url, function (_err, data) {
              var map = {};
              if (data && data.ok === true && Array.isArray(data.items)) {
                data.items.forEach(function (it) { map[String(it.id)] = it; });
              }
              renderSelected(map);
            });
          }

          function setResults(html) {
            resultsEl.innerHTML = html;
          }

          var lastQuery = '';
          function runSearch() {
            var query = String(searchInput.value || '').trim();
            if (query.length < 2) {
              setResults('<div class="px-3 py-3 text-xs text-gray-500">Tape au moins 2 lettres.</div>');
              return;
            }

            lastQuery = query;
            setResults('<div class="px-3 py-3 text-xs text-gray-500">Recherche…</div>');
            var url = '/admin/api/blog/search?q=' + encodeURIComponent(query) + '&limit=10';
            fetchJson(url, function (_err, data) {
              if (String(searchInput.value || '').trim() !== lastQuery) return;
              if (!data || data.ok !== true || !Array.isArray(data.items)) {
                setResults('<div class="px-3 py-3 text-xs text-red-600">Erreur de recherche.</div>');
                return;
              }

              var selected = new Set(getSelectedIds());
              if (!data.items.length) {
                setResults('<div class="px-3 py-3 text-xs text-gray-500">Aucun résultat.</div>');
                return;
              }

              resultsEl.innerHTML = '';
              data.items.forEach(function (it) {
                var row = document.createElement('button');
                row.type = 'button';
                row.className = 'w-full text-left px-3 py-3 hover:bg-gray-50 dark:hover:bg-gray-800 transition border-b border-border-light dark:border-border-dark last:border-0';

                var top = document.createElement('div');
                top.className = 'flex items-start justify-between gap-3';

                var left = document.createElement('div');
                left.className = 'min-w-0';

                var title = document.createElement('div');
                title.className = 'font-bold text-sm text-gray-900 dark:text-white truncate';
                title.textContent = it.title || it.slug;

                var meta = document.createElement('div');
                meta.className = 'mt-1 text-[11px] text-gray-500 truncate';
                meta.textContent = (it.categoryLabel ? it.categoryLabel : 'Blog') + (it.isPublished ? ' • publié' : ' • brouillon');

                left.appendChild(title);
                left.appendChild(meta);

                var right = document.createElement('div');
                right.className = 'shrink-0';
                var already = selected.has(String(it.id));
                var tag = document.createElement('span');
                tag.className = 'inline-flex items-center rounded-full px-2 py-1 text-[10px] font-black uppercase tracking-widest ' + (already ? 'bg-slate-100 text-slate-700' : 'bg-primary/10 text-primary');
                tag.textContent = already ? 'Déjà ajouté' : 'Ajouter';
                right.appendChild(tag);

                top.appendChild(left);
                top.appendChild(right);
                row.appendChild(top);

                row.addEventListener('click', function () {
                  var ids = getSelectedIds();
                  var id = String(it.id);
                  if (!ids.includes(id)) ids.push(id);
                  setSelectedIds(ids);
                  hydrateSelected();
                  runSearch();
                });

                resultsEl.appendChild(row);
              });
            });
          }

          var t = null;
          searchInput.addEventListener('input', function () {
            if (t) window.clearTimeout(t);
            t = window.setTimeout(runSearch, 220);
          });

          hydrateSelected();
          setResults('<div class="px-3 py-3 text-xs text-gray-500">Tape au moins 2 lettres.</div>');
        }

        setupRelatedBlogPostsPicker();
      })();
    </script>
  </div>
</main>

<%- include('./partials/footer') %>
