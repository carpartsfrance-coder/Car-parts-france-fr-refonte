<%- include('./partials/head') %>

<%- include('./partials/sidebar', { active: 'vehicle-makes' }) %>

<main class="flex-1">
  <div class="px-6 lg:px-10 py-8">
    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
      <div>
        <div class="text-2xl md:text-3xl font-black text-slate-900">Marques &amp; modèles</div>
        <div class="mt-1 text-sm text-slate-600">Gère la liste des marques et des modèles disponibles dans la compatibilité produit.</div>
      </div>
    </div>

    <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
      <div class="mt-6 rounded-xl border border-red-200 bg-red-50 p-4 text-red-900">
        <div class="font-bold">Erreur</div>
        <div class="mt-1 text-sm"><%= errorMessage %></div>
      </div>
    <% } %>

    <% if (!dbConnected) { %>
      <div class="mt-6 rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
        <div class="font-bold">Mode démo</div>
        <div class="mt-1 text-sm">La base de données est indisponible : tu ne peux pas modifier les marques/modèles.</div>
      </div>
    <% } %>

    <% const selectedMake = (makes && makes.length && selectedMakeId) ? makes.find((m) => m && m.id === selectedMakeId) : null; %>
    <% const selectedReturnTo = selectedMakeId ? ('/admin/vehicules?makeId=' + selectedMakeId) : '/admin/vehicules'; %>

    <div class="mt-8 grid grid-cols-1 xl:grid-cols-12 gap-6">
      <section class="xl:col-span-4">
        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
          <div class="px-6 py-4 bg-slate-50">
            <div class="font-black text-slate-900">Marques</div>
            <div class="mt-1 text-xs text-slate-500">
              <%= makes && makes.length ? makes.length : 0 %> marques
            </div>
          </div>

          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-bold text-slate-700" for="makeSearch">Recherche</label>
              <input class="mt-2 w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-semibold focus:ring-primary" id="makeSearch" placeholder="Tape une marque…" type="text" autocomplete="off" />
            </div>

            <div class="rounded-2xl border border-slate-200 overflow-hidden">
              <div class="max-h-[55vh] overflow-auto divide-y divide-slate-100" id="makesList">
                <% if (makes && makes.length) { %>
                  <% makes.forEach((m) => { %>
                    <% const isSelected = selectedMakeId && m && m.id === selectedMakeId; %>
                    <a
                      class="block px-4 py-3 hover:bg-slate-50 transition <%= isSelected ? 'bg-slate-900 text-white' : 'text-slate-900' %>"
                      data-make-row="1"
                      data-make-name="<%= (m && m.name ? m.name : '').toLowerCase() %>"
                      href="/admin/vehicules?makeId=<%= m.id %>"
                    >
                      <div class="flex items-center justify-between gap-3">
                        <div class="min-w-0">
                          <div class="text-sm font-black truncate"><%= m.name %></div>
                          <div class="mt-0.5 text-xs <%= isSelected ? 'text-white/70' : 'text-slate-500' %>">
                            <%= m.models && m.models.length ? m.models.length : 0 %> modèles
                          </div>
                        </div>
                        <span class="material-symbols-outlined text-base <%= isSelected ? 'text-white/80' : 'text-slate-400' %>">chevron_right</span>
                      </div>
                    </a>
                  <% }) %>
                <% } else { %>
                  <div class="p-4 text-sm text-slate-600">Aucune marque.</div>
                <% } %>
              </div>
            </div>

            <div class="rounded-2xl border border-slate-200 p-4">
              <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">Ajouter une marque</div>

              <form action="/admin/vehicules" class="mt-3 space-y-3" method="POST">
                <input type="hidden" name="returnTo" value="<%= selectedReturnTo %>" />
                <input class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-semibold focus:ring-primary" id="makeName" name="name" placeholder="Ex: Audi" required type="text" />
                <button class="w-full inline-flex items-center justify-center rounded-xl bg-primary px-5 py-3 text-xs font-black uppercase tracking-wider text-white hover:bg-red-700 transition" type="submit" <%= dbConnected ? '' : 'disabled' %>>
                  <span class="material-symbols-outlined mr-2 text-base">add</span>
                  Ajouter
                </button>
              </form>
            </div>
          </div>
        </div>
      </section>

      <section class="xl:col-span-8">
        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
          <div class="px-6 py-4 bg-slate-50">
            <div class="font-black text-slate-900">Détails</div>
            <div class="mt-1 text-xs text-slate-500">
              <% if (selectedMake) { %>
                <%= selectedMake.models && selectedMake.models.length ? selectedMake.models.length : 0 %> modèles
              <% } else { %>
                Sélectionne une marque
              <% } %>
            </div>
          </div>

          <div class="p-6">
            <% if (!selectedMake) { %>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6">
                <div class="text-sm font-black text-slate-900">Aucune marque sélectionnée</div>
                <div class="mt-1 text-sm text-slate-600">Clique sur une marque à gauche pour gérer ses modèles.</div>
              </div>
            <% } else { %>
              <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                <div class="min-w-0">
                  <div class="text-xl font-black text-slate-900 truncate"><%= selectedMake.name %></div>
                  <div class="mt-1 text-sm text-slate-600">Marque sélectionnée</div>
                </div>

                <div class="flex flex-col sm:flex-row gap-2">
                  <form action="/admin/vehicules/<%= selectedMake.id %>" method="POST" class="flex items-center gap-2">
                    <input type="hidden" name="returnTo" value="<%= selectedReturnTo %>" />
                    <input class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold" name="name" type="text" value="<%= selectedMake.name %>" />
                    <button class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-2 text-xs font-black uppercase tracking-wider text-white hover:bg-black transition" type="submit" <%= dbConnected ? '' : 'disabled' %>>
                      <span class="material-symbols-outlined mr-2 text-base">save</span>
                      Renommer
                    </button>
                  </form>

                  <form action="/admin/vehicules/<%= selectedMake.id %>/supprimer" method="POST" onsubmit="return confirm('Supprimer cette marque et tous ses modèles ?');">
                    <input type="hidden" name="returnTo" value="/admin/vehicules" />
                    <button class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-xs font-black uppercase tracking-wider text-slate-700 hover:bg-slate-50 transition" type="submit" <%= dbConnected ? '' : 'disabled' %>>
                      <span class="material-symbols-outlined mr-2 text-base">delete</span>
                      Supprimer
                    </button>
                  </form>
                </div>
              </div>

              <div class="mt-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-5">
                  <div class="rounded-2xl border border-slate-200 p-5">
                    <div class="text-[10px] font-black uppercase tracking-widest text-slate-400">Ajouter un modèle</div>
                    <form action="/admin/vehicules/<%= selectedMake.id %>/modeles" method="POST" class="mt-3 space-y-3">
                      <input type="hidden" name="returnTo" value="<%= selectedReturnTo %>" />
                      <input class="w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-semibold focus:ring-primary" name="modelName" placeholder="Ex: A3 (8V)" type="text" required />
                      <button class="w-full inline-flex items-center justify-center rounded-xl bg-primary px-5 py-3 text-xs font-black uppercase tracking-wider text-white hover:bg-red-700 transition" type="submit" <%= dbConnected ? '' : 'disabled' %>>
                        <span class="material-symbols-outlined mr-2 text-base">add</span>
                        Ajouter
                      </button>
                    </form>
                  </div>
                </div>

                <div class="lg:col-span-7">
                  <div class="rounded-2xl border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50">
                      <label class="block text-sm font-bold text-slate-700" for="modelSearch">Recherche modèle</label>
                      <input class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold focus:ring-primary" id="modelSearch" placeholder="Tape un modèle…" type="text" autocomplete="off" />
                    </div>

                    <div class="max-h-[55vh] overflow-auto" id="modelsList">
                      <% if (selectedMake.models && selectedMake.models.length) { %>
                        <div class="divide-y divide-slate-100">
                          <% selectedMake.models.forEach((mod) => { %>
                            <div class="p-4 flex items-center justify-between gap-3" data-model-row="1" data-model-name="<%= (mod && mod.name ? mod.name : '').toLowerCase() %>">
                              <form action="/admin/vehicules/<%= selectedMake.id %>/modeles/<%= mod.id %>" method="POST" class="flex-1 flex items-center gap-2 min-w-0">
                                <input type="hidden" name="returnTo" value="<%= selectedReturnTo %>" />
                                <input class="w-full min-w-0 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold" name="modelName" type="text" value="<%= mod.name %>" />
                                <button class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-3 py-2 text-xs font-black uppercase tracking-wider text-white hover:bg-black transition" type="submit" <%= dbConnected ? '' : 'disabled' %>>
                                  <span class="material-symbols-outlined text-base">save</span>
                                </button>
                              </form>

                              <form action="/admin/vehicules/<%= selectedMake.id %>/modeles/<%= mod.id %>/supprimer" method="POST" onsubmit="return confirm('Supprimer ce modèle ?');">
                                <input type="hidden" name="returnTo" value="<%= selectedReturnTo %>" />
                                <button class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-black uppercase tracking-wider text-slate-700 hover:bg-slate-50 transition" type="submit" <%= dbConnected ? '' : 'disabled' %>>
                                  <span class="material-symbols-outlined text-base">close</span>
                                </button>
                              </form>
                            </div>
                          <% }) %>
                        </div>
                      <% } else { %>
                        <div class="p-6 text-sm text-slate-600">Aucun modèle pour cette marque.</div>
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

<script>
  (function () {
    const makeSearch = document.getElementById('makeSearch');
    const makesList = document.getElementById('makesList');
    if (makeSearch && makesList) {
      makeSearch.addEventListener('input', function () {
        const q = (makeSearch.value || '').trim().toLowerCase();
        const rows = makesList.querySelectorAll('[data-make-row]');
        rows.forEach((row) => {
          const name = (row.getAttribute('data-make-name') || '').toLowerCase();
          row.style.display = !q || name.includes(q) ? '' : 'none';
        });
      });
    }

    const modelSearch = document.getElementById('modelSearch');
    const modelsList = document.getElementById('modelsList');
    if (modelSearch && modelsList) {
      modelSearch.addEventListener('input', function () {
        const q = (modelSearch.value || '').trim().toLowerCase();
        const rows = modelsList.querySelectorAll('[data-model-row]');
        rows.forEach((row) => {
          const name = (row.getAttribute('data-model-name') || '').toLowerCase();
          row.style.display = !q || name.includes(q) ? '' : 'none';
        });
      });
    }
  })();
</script>

<%- include('./partials/footer') %>
